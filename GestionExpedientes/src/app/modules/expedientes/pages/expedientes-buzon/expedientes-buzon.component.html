<div class="w-full h-full bg-gray-100 p-6">
  <!-- BREADCRUMB Y TÍTULO -->
  <div class="text-sm text-gray-600 mb-4">
    <span class="text-[#004C77] font-semibold">Inicio</span> &gt;
    <span class="text-[#004C77] font-semibold">Expedientes</span> &gt;
    <span class="text-[#F36C21] font-semibold">Buzón Expedientes</span>
  </div>

  <div class="flex justify-between items-center mb-2">
    <h1 class="text-2xl font-bold text-[#004C77]">Buzón de Expedientes Asignados</h1>
  </div>

  <hr class="border-t-2 border-[#004C77] rounded-full mb-6" />

  <!-- CONTENIDO PRINCIPAL -->
  <div class="flex w-full h-[750px] bg-white shadow rounded-lg overflow-hidden relative custom-scroll">
    <!-- LADO IZQUIERDO: BANDEJA -->
    <!-- PANEL IZQUIERDO -->
    <div
      class="flex-shrink-0 flex h-full w-[42%] min-w-[360px] bg-white border-r border-gray-200 relative z-20 overflow-hidden shadow-[2px_0_4px_rgba(0,0,0,0.03)] custom-scroll">

      <!-- PESTAÑAS VERTICALES -->
      <div class="flex flex-col bg-gray-100 border-r border-gray-300">
        <button (click)="filtroTipo = 'todos'; aplicarFiltros()"
          class="cursor-pointer w-[48px] h-[130px] flex items-center justify-center text-xs font-medium transition"
          [ngClass]="{
        'bg-white border-r-4 border-[#004C77] text-[#004C77]': filtroTipo === 'todos',
        'text-gray-600 hover:bg-gray-200': filtroTipo !== 'todos'
      }">
          <span class="transform -rotate-90 whitespace-nowrap">Todos los tipos</span>
        </button>

        <button (click)="filtroTipo = 'Receptor'; aplicarFiltros()"
          class="cursor-pointer w-[48px] h-[130px] flex items-center justify-center text-xs font-medium transition"
          [ngClass]="{
        'bg-white border-r-4 border-[#004C77] text-[#004C77]': filtroTipo === 'Receptor',
        'text-gray-600 hover:bg-gray-200': filtroTipo !== 'Receptor'
      }">
          <span class="transform -rotate-90 whitespace-nowrap">Receptores</span>
        </button>

        <button (click)="filtroTipo = 'Emisor'; aplicarFiltros()"
          class="cursor-pointer w-[48px] h-[130px] flex items-center justify-center text-xs font-medium transition"
          [ngClass]="{
        'bg-white border-r-4 border-[#004C77] text-[#004C77]': filtroTipo === 'Emisor',
        'text-gray-600 hover:bg-gray-200': filtroTipo !== 'Emisor'
      }">
          <span class="transform -rotate-90 whitespace-nowrap">Emisores</span>
        </button>
      </div>

      <!-- CONTENIDO DE LA LISTA -->
      <div class="flex flex-col flex-1 overflow-hidden bg-white custom-scroll">
        <!-- FILTROS SUPERIORES -->
        <div class="flex justify-around text-sm text-gray-700 py-2 bg-white shadow-sm rounded-t-md">
          <button (click)="filtrar('recientes')" class="px-4 py-1 rounded font-medium" [ngClass]="{
          'text-[#004C77] bg-[#F0F8FF]': filtroActivo === 'recientes',
          'hover:bg-gray-100': filtroActivo !== 'recientes'
        }">
            Recientes
          </button>
          <button (click)="filtrar('todos')" class="px-4 py-1 rounded font-medium" [ngClass]="{
          'text-[#004C77] bg-[#F0F8FF]': filtroActivo === 'todos',
          'hover:bg-gray-100': filtroActivo !== 'todos'
        }">
            Todos
          </button>
          <button (click)="filtrar('archivados')" class="px-4 py-1 rounded font-medium" [ngClass]="{
          'text-[#004C77] bg-[#F0F8FF]': filtroActivo === 'archivados',
          'hover:bg-gray-100': filtroActivo !== 'archivados'
        }">
            Archivados
          </button>
        </div>

        <!-- MODO ADMIN -->
        <div *ngIf="esAdmin" class="text-xs text-green-700 px-4 pt-2">
          Estás viendo todos los expedientes (modo administrador).
        </div>

        <!-- LISTA DE EXPEDIENTES -->
        <div class="flex-1 overflow-y-auto p-2 pr-3 custom-scroll">
          <div *ngFor="let exp of expedientesFiltrados">
            <div class="relative group border-b border-gray-100 rounded-md transition-all duration-200" [ngClass]="{
            'bg-[#EAF4FB]/80 border-l-4 border-[#004C77] shadow-sm': expedienteSeleccionado?.id === exp?.id,
            'hover:bg-[#F8FAFC]': expedienteSeleccionado?.id !== exp?.id
          }">

              <div class="px-4 py-2.5 cursor-pointer flex justify-between items-center" (click)="verDetalle(exp)">
                <div class="flex flex-col max-w-[65%]">
                  <div class="font-semibold text-[#004C77] text-[13px] leading-snug truncate">
                    {{ exp.asunto }}
                  </div>
                  <div class="flex gap-2 items-center text-[11px] text-gray-500">
                    <span>{{ exp.fecha }}</span>
                    <span class="text-gray-300">•</span>
                    <span class="text-gray-400">#{{ exp.codigo }}</span>
                  </div>
                </div>

                <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                  <div *ngIf="exp.estado === 'PENDIENTE'" class="flex items-center gap-1.5 text-[10px] font-medium px-2.5 py-0.5
         border border-transparent rounded-md transition-all duration-200 shadow-sm" [ngClass]="{
    'bg-[#004C77]/10 text-[#004C77]': exp?.tipoExpediente === 'Receptor',
    'bg-[#F36C21]/10 text-[#F36C21]': exp?.tipoExpediente === 'Emisor'
  }">

                    <mat-icon class="estado-icon">
                      {{ exp.tipoExpediente === 'Receptor' ? 'hourglass_empty' : 'edit_document' }}
                    </mat-icon>

                    <span class="whitespace-nowrap tracking-wide">
                      {{ exp.tipoExpediente === 'Receptor' ? 'Pendiente de aprobación' : 'Pendiente a firma' }}
                    </span>
                  </div>


                  <!-- ICONOS DE ACCIÓN -->
                  <div class="flex items-center gap-1.5 text-gray-400">
                    <mat-icon matTooltip="Marcar como leído" (click)="marcarComoLeido($event, exp)"
                      class="hover:text-green-600 cursor-pointer text-[18px] transition-colors duration-200">
                      mark_email_read
                    </mat-icon>
                    <mat-icon matTooltip="Archivar" (click)="archivar($event, exp)"
                      class="hover:text-yellow-600 cursor-pointer text-[18px] transition-colors duration-200">
                      archive
                    </mat-icon>
                    <mat-icon matTooltip="Eliminar" (click)="eliminar($event, exp)"
                      class="hover:text-red-600 cursor-pointer text-[18px] transition-colors duration-200">
                      delete
                    </mat-icon>
                  </div>
                </div>
              </div>

              <div *ngIf="!exp.leido" class="absolute left-2 top-5 h-2 w-2 rounded-full bg-[#F36C21]"></div>
            </div>
          </div>

          <div *ngIf="expedientesFiltrados.length === 0" class="p-4 text-center text-gray-500">
            No hay expedientes para mostrar.
          </div>
        </div>
      </div>
    </div>

    <!-- LADO DERECHO: DETALLE -->
    <div
      class="flex-1 h-full p-6 relative overflow-y-auto bg-white z-10 md:z-0 md:block hidden border-l border-gray-100 custom-scroll">
      <!-- Si no hay expediente seleccionado -->
      <div *ngIf="!expedienteSeleccionado"
        class="h-full flex flex-col justify-center items-center text-center text-gray-400">
        <mat-icon class="text-7xl mb-3 text-[#004C77]">mail_outline</mat-icon>
        <p class="text-lg">Selecciona un expediente para ver sus detalles</p>
      </div>
      <!-- DETALLE DE EXPEDIENTE -->
      <div *ngIf="expedienteSeleccionado" class="space-y-2">
        <!-- Botón Volver -->
        <div class="flex flex-wrap items-center justify-between gap-4 border-b border-gray-300 pb-1 mb-4">

          <!-- Botón Volver -->
          <button (click)="expedienteSeleccionado = null"
            class="flex items-center gap-2 text-[#004C77] hover:text-[#F36C21] font-medium transition-colors duration-200 cursor-pointer">
            <mat-icon class="text-base">arrow_back</mat-icon>
            <span class="text-sm">Volver</span>
          </button>

          <!-- Botón Ver expediente completo -->
          <button (click)="abrirDetalle(expedienteSeleccionado)"
            class="flex items-center gap-2 text-[#004C77] bg-white px-4 py-2 text-sm font-medium rounded-md hover:bg-[#f2f9fc] hover:border-[#06334f] hover:text-[#06334f] transition-colors duration-200 cursor-pointer"
            title="Ver expediente completo">
            <mat-icon class="text-sm">open_in_new</mat-icon>
            <span>Ver expediente completo</span>
          </button>
        </div>


        <!-- Tarjeta principal -->
        <div class="bg-white border border-gray-200 shadow rounded-xl px-6 space-y-5" [@fadeInOut]>
          <!-- Tabs -->
          <!-- Tabs -->
          <div class="border-b border-gray-200 mt-2 mb-2">
            <nav class="flex space-x-4 text-sm font-medium">

              <!-- Mostrar el tab de Firmas solo si es Emisor -->
              <button *ngIf="expedienteSeleccionado?.tipo === 'Emisor'" (click)="tabActivo = 'firmas'" [ngClass]="{
        'text-[#004C77] border-b-2 border-[#004C77]': tabActivo === 'firmas',
        'text-gray-500 hover:text-[#004C77]': tabActivo !== 'firmas'
      }" class="cursor-pointer px-4 py-2 transition">
                Firmas
              </button>

              <button (click)="tabActivo = 'expediente'" [ngClass]="{
        'text-[#004C77] border-b-2 border-[#004C77]': tabActivo === 'expediente',
        'text-gray-500 hover:text-[#004C77]': tabActivo !== 'expediente'
      }" class="cursor-pointer px-4 py-2 transition">
                Expediente
              </button>

              <button (click)="tabActivo = 'documentos'" [ngClass]="{
        'text-[#004C77] border-b-2 border-[#004C77]': tabActivo === 'documentos',
        'text-gray-500 hover:text-[#004C77]': tabActivo !== 'documentos'
      }" class="cursor-pointer px-4 py-2 transition">
                Documentos
              </button>
            </nav>
          </div>
          <div *ngIf="cargandoDetalle" class="flex justify-center items-center h-full text-gray-400">
            <mat-icon class="animate-spin text-4xl mr-2">autorenew</mat-icon>
            Cargando expediente...
          </div>
          <!-- Contenido de tabs -->
          <div [ngClass]="{
    'h-[195px]': expedienteSeleccionado?.tipo === 'Receptor',
    'h-[545px]': expedienteSeleccionado?.tipo === 'Emisor'
  }" class="overflow-y-auto overflow-x-auto pr-2 custom-scroll">
            <!-- TAB: EXPEDIENTE -->

            <div *ngIf="tabActivo === 'expediente'">
              <!-- Título -->
              <div class="flex items-center gap-2 py-3 text-2xl font-bold text-[#004C77]">
                <span>Detalles del Expediente</span>
              </div>

              <!-- Detalles del Expediente con estilo tipo tabla -->
              <div class="space-y-3 text-sm text-gray-700">
                <!-- Fila 1 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 rounded-lg py-2 px-4 shadow-sm">
                  <div class="flex items-start gap-3">
                    <mat-icon class="text-[#004C77] mt-1">confirmation_number</mat-icon>
                    <div>
                      <div class="text-xs text-gray-500">Código</div>
                      <div class="font-semibold text-[#004C77]">{{ expedienteSeleccionado.codigo }}</div>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <mat-icon class="text-[#004C77] mt-1">category</mat-icon>
                    <div>
                      <div class="text-xs text-gray-500">Tipo</div>
                      <div class="font-medium">{{ expedienteSeleccionado.tipo }}</div>
                    </div>
                  </div>
                </div>

                <!-- Fila 2 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white rounded-lg p-4 shadow-sm">
                  <div class="flex items-start gap-3">
                    <mat-icon class="text-[#004C77] mt-1">event</mat-icon>
                    <div>
                      <div class="text-xs text-gray-500">Fecha</div>
                      <div>{{ expedienteSeleccionado.fecha }}</div>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <mat-icon class="text-[#004C77] mt-1">work_outline</mat-icon>
                    <div>
                      <div class="text-xs text-gray-500">Proyecto</div>
                      <div>{{ nombreProyectoSeleccionado || 'Sin proyecto' }}</div>
                    </div>
                  </div>
                </div>

                <!-- Fila 3: Estado y privacidad -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 rounded-lg p-4 shadow-sm">
                  <div class="flex items-start gap-3">
                    <mat-icon class="text-[#004C77] mt-1">info</mat-icon>
                    <div>
                      <div class="text-xs text-gray-500">Estado</div>
                      <div [ngClass]="{
              'text-yellow-600 font-semibold': expedienteSeleccionado?.estado === 'PENDIENTE',
              'text-green-600 font-semibold': expedienteSeleccionado?.estado === 'APROBADO',
              'text-red-600 font-semibold': expedienteSeleccionado?.estado === 'RECHAZADO',
              'text-gray-400 italic': !expedienteSeleccionado?.estado
            }">
                        {{ expedienteSeleccionado.estado || 'SIN ESTADO' }}
                      </div>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <mat-icon class="text-[#004C77] mt-1">lock</mat-icon>
                    <div>
                      <div class="text-xs text-gray-500">Privacidad</div>
                      <div
                        [ngClass]="expedienteSeleccionado.reservado ? 'text-red-500 font-semibold' : 'text-gray-500 italic'">
                        {{ expedienteSeleccionado.reservado ? 'Reservado' : 'No reservado' }}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Fila 4: Comentario -->
                <div class="flex items-start gap-3 bg-white rounded-lg p-4 shadow-sm">
                  <mat-icon class="text-[#004C77] mt-1">chat</mat-icon>
                  <div>
                    <div class="text-xs text-gray-500">Comentario</div>
                    <div class="italic text-gray-700">
                      {{ expedienteSeleccionado.comentario || 'Sin comentario' }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Usuarios -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 py-6">
                <div>
                  <h3 class="text-sm font-semibold text-[#004C77] mb-2 flex items-center gap-1">
                    <mat-icon class="text-base">send</mat-icon> Emisores
                  </h3>
                  <ul class="list-disc list-inside text-sm text-gray-700 space-y-0.5">
                    <li *ngFor="let u of expedienteSeleccionado.usuariosEmisores">
                      {{ u.nombre }} ({{ u.correo }})
                    </li>
                  </ul>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-[#004C77] mb-2 flex items-center gap-1">
                    <mat-icon class="text-base">inbox</mat-icon> Destinatarios
                  </h3>
                  <ul class="list-disc list-inside text-sm text-gray-700 space-y-0.5">
                    <li *ngFor="let u of expedienteSeleccionado.usuariosDestinatarios">
                      {{ u.nombre }} ({{ u.correo }})
                    </li>
                  </ul>
                </div>
              </div>
            </div>


            <!-- TAB: DOCUMENTOS -->
            <div *ngIf="tabActivo === 'documentos'">
              <div class="flex items-center gap-2 py-4 text-2xl font-bold text-[#004C77]">
                <span>Detalles de los Documentos</span>
              </div>

              <!-- Subtítulo -->
              <div
                class="flex items-center gap-2 mb-2 text-sm font-semibold text-[#004C77] border-b border-[#004C77]/30 pb-1">
                <mat-icon class="text-base text-[#004C77]">attach_file</mat-icon>
                DOCUMENTOS ASOCIADOS
              </div>

              <!-- Documentos -->
              <div *ngIf="expedienteSeleccionado.documentos?.length; else sinDocumentos"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 pt-1 pb-4">
                <div *ngFor="let doc of expedienteSeleccionado.documentos" class="bg-white border border-gray-200 rounded-lg
         shadow-[0_2px_6px_rgba(0,0,0,0.06)] hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)]
         transition-all duration-300 ease-in-out transform hover:scale-[1.015]
         p-4 flex justify-between items-start">
                  <div class="max-w-[85%]">

                    <p class="font-semibold text-[#004C77] text-sm truncate">{{ doc.nombreArchivo }}</p>
                    <p class="text-xs text-gray-500 italic">
                      {{ doc.tipoDocumento || 'No especificado' }} • {{ formatearPeso(doc['tamaño']) }}
                    </p>
                  </div>
                  <button (click)="abrirEnNuevaVentana(transformarRutaDocumento(doc.rutaArchivo)!)"
                    matTooltip="Ver documento"
                    class="text-[#004C77] hover:text-[#F36C21] transition p-1 cursor-pointer">
                    <mat-icon>visibility</mat-icon>
                  </button>
                </div>
              </div>

              <ng-template #sinDocumentos>
                <div class="text-center py-6 text-gray-500 italic">
                  No tienes documentos asociados en este expediente.
                </div>
              </ng-template>
            </div>

            <!-- === TAB: FIRMAS con estilo tipo dashboard === -->
            <div *ngIf="tabActivo === 'firmas'" class="space-y-8 pb-10">

              <!-- Título principal -->
              <div class="flex items-center gap-3 pt-4">
                <h2 class="text-2xl font-bold text-[#004C77]">Documentos Disponibles de Firma</h2>
              </div>

              <!-- === FLUJO POR DOCUMENTO === -->
              <div *ngIf="modoFlujoFirma === 'individual' && nivelesFirmaPorDocumento?.length" class="space-y-6">

                <div class="flex items-center gap-2">
                  <h3 class="text-lg font-semibold text-[#004C77]">Flujo de Firma por Documento</h3>
                </div>

                <div *ngFor="let flujoDoc of nivelesFirmaPorDocumento" class="space-y-4">

                  <!-- Encabezado del documento -->
                  <div
                    class="bg-white border border-gray-200 rounded-lg shadow-sm transition-all duration-200 hover:shadow-md">
                    <div class="border-t-4 border-[#004C77] rounded-t-lg p-4 flex justify-between items-center">
                      <div>
                        <h4 class="text-base font-semibold text-[#004C77]">
                          Documento <span class="font-bold">#{{ flujoDoc.documentoId }}</span>
                        </h4>
                      </div>
                      <mat-icon class="text-[#004C77]">folder_open</mat-icon>
                    </div>

                    <!-- Niveles de firma -->
                    <div class="p-4 space-y-3">
                      <div *ngFor="let nivel of flujoDoc.niveles"
                        class="rounded-lg border transition-all duration-200 p-4" [ngClass]="{
                 'border-t-4 border-green-500': nivel.estado === 'FIRMADO',
                 'border-t-4 border-[#F36C21]': nivel.estado === 'PENDIENTE',
                 'border-t-4 border-gray-300': !nivel.estado
               }">

                        <!-- Cabecera del nivel -->
                        <div class="flex justify-between items-center mb-3">
                          <div class="flex items-center gap-2">
                            <mat-icon *ngIf="nivel.estado === 'FIRMADO'" class="text-green-600">check_circle</mat-icon>
                            <mat-icon *ngIf="nivel.estado === 'PENDIENTE'"
                              class="text-[#F36C21]">hourglass_top</mat-icon>
                            <mat-icon *ngIf="!nivel.estado" class="text-gray-400">radio_button_unchecked</mat-icon>

                            <span class="text-[#004C77] font-semibold text-sm">
                              Nivel {{ nivel.nivel }}
                            </span>
                          </div>

                          <span class="text-xs uppercase font-semibold tracking-wide" [ngClass]="{
                      'text-green-700': nivel.estado === 'FIRMADO',
                      'text-[#F36C21]': nivel.estado === 'PENDIENTE',
                      'text-gray-500': !nivel.estado
                    }">
                            {{ nivel.estado || 'SIN ESTADO' }}
                          </span>
                        </div>

                        <!-- Usuarios del nivel -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                          <div *ngFor="let userId of nivel.usuarios"
                            class="flex items-center justify-between bg-white border border-gray-200 rounded-md px-4 py-2 shadow-sm hover:shadow-md transition-all duration-200">
                            <div class="flex items-center gap-3">
                              <mat-icon
                                [ngClass]="nivel.usuariosFirmantes?.includes(userId) ? 'text-green-600' : 'text-[#004C77]'">
                                {{ nivel.usuariosFirmantes?.includes(userId) ? 'verified' : 'person_outline' }}
                              </mat-icon>

                              <div>
                                <p class="text-sm font-semibold text-[#004C77]">
                                  ID {{ userId }} — {{ obtenerNombreUsuario(userId) }}
                                </p>
                                <p class="text-xs" [ngClass]="nivel.usuariosFirmantes?.includes(userId)
                                   ? 'text-green-600 font-medium'
                                   : 'text-gray-400 italic'">
                                  {{ nivel.usuariosFirmantes?.includes(userId) ? 'Firmado' : 'Pendiente' }}
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>

                      </div>
                    </div>
                  </div>

                </div>
              </div>
              <!-- === FLUJO DE FIRMA GENERAL === -->
              <div *ngIf="modoFlujoFirma === 'general' && nivelesFirmaGeneral?.length" class="space-y-4">

                <div class="flex items-center gap-2 mb-3">
                  <h3 class="text-lg font-semibold text-[#004C77]">
                    Flujo de Firma General
                  </h3>
                </div>

                <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5">
                  <div *ngFor="let nivel of nivelesFirmaGeneral"
                    class="rounded-lg border p-4 mb-4 transition-all duration-200" [ngClass]="{
           'border-t-4 border-green-500 bg-green-50': nivel.estado === 'FIRMADO',
           'border-t-4 border-[#F36C21] bg-orange-50': nivel.estado === 'PENDIENTE',
           'border-t-4 border-gray-300 bg-gray-50': !nivel.estado
         }">

                    <!-- Cabecera nivel -->
                    <div class="flex justify-between items-center mb-3">
                      <div class="flex items-center gap-2">
                        <mat-icon *ngIf="nivel.estado === 'FIRMADO'" class="text-green-600">verified</mat-icon>
                        <mat-icon *ngIf="nivel.estado === 'PENDIENTE'" class="text-[#F36C21]">hourglass_top</mat-icon>
                        <mat-icon *ngIf="!nivel.estado" class="text-gray-400">radio_button_unchecked</mat-icon>

                        <span class="text-[#004C77] font-semibold text-sm">Nivel {{ nivel.nivel }}</span>
                      </div>

                      <span class="text-xs uppercase font-semibold tracking-wide" [ngClass]="{
                'text-green-700': nivel.estado === 'FIRMADO',
                'text-[#F36C21]': nivel.estado === 'PENDIENTE',
                'text-gray-500': !nivel.estado
              }">
                        {{ nivel.estado || 'SIN ESTADO' }}
                      </span>
                    </div>

                    <!-- Usuarios asignados -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                      <div *ngFor="let userId of nivel.usuarios"
                        class="flex items-center justify-between bg-white border border-gray-200 rounded-md px-4 py-2 shadow-sm hover:shadow-md transition-all duration-200">
                        <div class="flex items-center gap-3">
                          <mat-icon
                            [ngClass]="nivel.usuariosFirmantes?.includes(userId) ? 'text-green-600' : 'text-[#004C77]'">
                            {{ nivel.usuariosFirmantes?.includes(userId) ? 'verified' : 'person_outline' }}
                          </mat-icon>

                          <div>
                            <p class="text-sm font-semibold text-[#004C77]">
                              ID {{ userId }} — {{ obtenerNombreUsuario(userId) }}
                            </p>
                            <p class="text-xs" [ngClass]="nivel.usuariosFirmantes?.includes(userId)
                             ? 'text-green-600 font-medium'
                             : 'text-gray-400 italic'">
                              {{ nivel.usuariosFirmantes?.includes(userId) ? 'Firmado' : 'Pendiente' }}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>

              <!-- === DOCUMENTOS LISTOS PARA FIRMAR === -->
              <div>
                <div class="flex items-center gap-2 mb-3 border-b border-[#004C77]/30 pb-1">
                  <mat-icon class="text-[#004C77] text-lg">how_to_reg</mat-icon>
                  <h3 class="text-sm font-semibold text-[#004C77] uppercase">Documentos Listos para Firmar</h3>
                </div>

                <div *ngIf="documentosFirmables && documentosFirmables.length > 0; else sinFirmas">
                  <div *ngFor="let doc of documentosFirmables"
                    class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 p-5 flex justify-between items-center border-t-4 border-[#F36C21]">

                    <div class="max-w-[65%]">
                      <p class="font-semibold text-[#004C77] truncate text-sm">{{ doc.nombreArchivo }}</p>
                      <p class="text-xs text-gray-500 italic">
                        {{ (doc.tipoDocumento?.split('|')[0]) || 'No especificado' }} • {{ formatearPeso(doc['tamaño'])
                        }}
                      </p>
                    </div>

                    <div class="flex items-center gap-3">
                      <button matTooltip="Observar detalles" (click)="observarNivel(doc)"
                        class="cursor-pointer border border-[#004C77] text-[#004C77] px-3 py-1 rounded-md hover:bg-[#004C77] hover:text-white transition text-xs font-medium">
                        Observar
                      </button>

                      <button matTooltip="Firmar documento" (click)="firmar(doc)" *ngIf="doc.puedeFirmar"
                        class="cursor-pointer border border-[#F36C21] text-[#F36C21] px-3 py-1 rounded-md hover:bg-[#F36C21] hover:text-white transition text-xs font-medium">
                        Firmar
                      </button>

                      <button matTooltip="Ver documento"
                        (click)="abrirEnNuevaVentana(transformarRutaDocumento(doc.rutaArchivo)!)"
                        class="cursor-pointer text-[#004C77] hover:text-[#F36C21] transition cursor-pointer">
                        <mat-icon>visibility</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>

                <ng-template #sinFirmas>
                  <div
                    class="text-center py-6 text-gray-500 italic border border-dashed border-gray-300 rounded-lg bg-gray-50">
                    No tienes documentos pendientes de firma en este expediente.
                  </div>
                </ng-template>
              </div>

            </div>

          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-md p-5 space-y-6 border border-gray-200"
          *ngIf="expedienteSeleccionado?.tipo === 'Receptor'">
          <!-- Título de sección -->
          <div class="border-b border-gray-200 pb-2">
            <h3 class="text-lg font-semibold text-[#004C77] tracking-wide">Acciones del Receptor</h3>
          </div>

          <!-- Comentario adicional -->
          <div class="space-y-2">
            <label class="text-sm text-gray-700 font-medium block">Comentario adicional:</label>
            <textarea [(ngModel)]="nuevoComentario" rows="3"
              class="w-full p-3 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-[#004C77] focus:border-[#004C77]"
              placeholder="Escribe tu comentario aquí..."></textarea>
            <div class="flex justify-end">
              <button
                class="cursor-pointer bg-[#004C77] text-white px-5 py-2 w-52.5 rounded-md hover:bg-[#06334f] transition-colors font-medium shadow-sm"
                (click)="guardarComentario()">
                Guardar comentario
              </button>
            </div>
          </div>

          <!-- Si está pendiente -->
          <div *ngIf="expedienteSeleccionado.estado === 'PENDIENTE'; else seccionAprobado">
            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
              <label class="text-sm text-gray-700 font-medium block">Fecha Limite de Respuesta:</label>

              <input type="date"
                class="cursor-pointer border border-gray-300 p-2 rounded-md w-full sm:w-auto focus:ring-2 focus:ring-[#004C77] focus:border-[#004C77]"
                [(ngModel)]="expedienteSeleccionado.fechaSeleccionada" placeholder="Selecciona fecha límite" />

              <button
                class="cursor-pointer bg-[#004C77] text-white px-5 py-2 w-52.5 rounded-md hover:bg-[#06334f] transition-colors disabled:opacity-50"
                [disabled]="!expedienteSeleccionado.fechaSeleccionada"
                (click)="confirmarAccion(expedienteSeleccionado, 'APROBADO')">
                Aceptar
              </button>

              <button
                class="cursor-pointer bg-[#F36C21] text-white px-5 py-2 w-52.5 rounded-md hover:bg-[#d65a17] transition-colors"
                (click)="confirmarAccion(expedienteSeleccionado, 'RECHAZADO')">
                Rechazar
              </button>
            </div>
          </div>

          <!-- Si ya fue aprobado -->
          <ng-template #seccionAprobado>
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
              <div class="flex items-center gap-3 w-full sm:w-auto">
                <label class="text-sm font-medium text-gray-700">Fecha límite:</label>
                <input type="date"
                  class="cursor-pointer border border-gray-300 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-[#004C77] focus:border-[#004C77]"
                  [(ngModel)]="expedienteSeleccionado.fechaLimiteRespuesta" (change)="actualizarFechaLimite()" />
              </div>

              <button *ngIf="expedienteSeleccionado.estado === 'APROBADO'"
                class="cursor-pointer bg-[#F36C21] text-white px-5 py-2 w-52.5 rounded-md hover:bg-[#d65a17] transition-colors"
                (click)="irARegistroExpedienteEmisor(expedienteSeleccionado)">
                Expediente Emisor
              </button>
            </div>
          </ng-template>
        </div>


      </div>
    </div>

  </div>
</div>