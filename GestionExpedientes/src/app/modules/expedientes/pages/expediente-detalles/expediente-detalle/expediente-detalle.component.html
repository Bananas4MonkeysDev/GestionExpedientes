<div class="bg-gray-100 p-8">
    <div>
        <!-- Breadcrumb -->
        <div class="text-sm text-gray-600 mb-4">
            <span class="text-[#004C77] font-semibold">Inicio</span> &gt;
            <span class="text-[#004C77] font-semibold">Expediente {{ expediente?.codigo }}</span> &gt;
            <span class="text-[#F36C21] font-semibold">Detalles</span>
        </div>

        <!-- Título con botón al lado derecho -->
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-2xl font-bold text-[#004C77]">Detalles del Expediente</h1>
            <button (click)="irARegistroExpediente()" matTooltip="Registrar nuevo expediente"
                class="cursor-pointer flex items-center gap-2 px-4 py-1 text-sm rounded-md bg-[#004C77] text-white hover:bg-[#F36C21] transition-all">
                <mat-icon class="!text-white">add</mat-icon>
                Nuevo Expediente
            </button>
        </div>

        <!-- Línea divisora con margen inferior -->
        <hr class="border-t-2 border-[#004C77] rounded-full mb-6" />

        <!-- Contenedor principal -->
        <div class="w-full bg-white shadow rounded-xl p-6 space-y-6">

            <!-- Pestañas -->
            <div class="flex gap-6 text-sm font-medium">
                <button (click)="seccion = 'expediente'"
                    [ngClass]="seccion === 'expediente' ? 'border-b-2 border-[#004C77] text-[#004C77]' : 'text-gray-500 hover:text-[#004C77]'"
                    class="cursor-pointer pb-2">Expediente</button>

                <button (click)="seccion = 'documentos'"
                    [ngClass]="seccion === 'documentos' ? 'border-b-2 border-[#004C77] text-[#004C77]' : 'text-gray-500 hover:text-[#004C77]'"
                    class="cursor-pointer pb-2">Documentos</button>

                <button (click)="seccion = 'cargo'"
                    [ngClass]="seccion === 'cargo' ? 'border-b-2 border-[#004C77] text-[#004C77]' : 'text-gray-500 hover:text-[#004C77]'"
                    class="cursor-pointer pb-2">Cargo</button>

                <button (click)="seccion = 'estado'"
                    [ngClass]="seccion === 'estado' ? 'border-b-2 border-[#004C77] text-[#004C77]' : 'text-gray-500 hover:text-[#004C77]'"
                    class="cursor-pointer pb-2">Estado del Proceso</button>

                <button (click)="onTabChange('auditoria')"
                    [ngClass]="seccion === 'auditoria' ? 'border-b-2 border-[#004C77] text-[#004C77]' : 'text-gray-500 hover:text-[#004C77]'"
                    class="cursor-pointer pb-2">Auditoría / Trazabilidad</button>
            </div>

            <!-- Contenido -->
            <ng-container [ngSwitch]="seccion">

                <!-- Expediente -->
                <div *ngSwitchCase="'expediente'" class="space-y-6 text-sm text-gray-700">

                    <!-- Tarjeta de acciones -->
                    <div
                        class="bg-gray-50 border border-gray-200 rounded-md p-4 mb-6 flex flex-wrap justify-between items-center gap-4 shadow-sm">

                        <!-- Estado del expediente con ícono -->
                        <!-- Estado del expediente con ícono y estilo integrado -->
                        <div *ngIf="expediente"
                            class="inline-flex items-center px-4 py-1 rounded-full text-sm font-semibold uppercase gap-2"
                            [ngClass]="{
    'bg-yellow-100 text-yellow-800': expediente.estado === 'PENDIENTE',
    'bg-green-100 text-green-800': expediente.estado === 'APROBADO',
    'bg-red-100 text-red-800': expediente.estado === 'RECHAZADO',
    'bg-gray-200 text-gray-600': expediente.estado === 'ANULADO',
    'bg-gray-100 text-gray-500': !expediente.estado
  }">

                            <mat-icon [ngClass]="{
    '!text-yellow-600': expediente.estado === 'PENDIENTE',
    '!text-green-600': expediente.estado === 'APROBADO',
    '!text-red-600': expediente.estado === 'RECHAZADO',
    '!text-gray-400': expediente.estado === 'ANULADO' || !expediente.estado
  }" class="text-base !m-0 !p-0 transition-none">
                                {{
                                expediente.estado === 'PENDIENTE' ? 'hourglass_empty' :
                                expediente.estado === 'APROBADO' ? 'check_circle' :
                                expediente.estado === 'RECHAZADO' ? 'cancel' :
                                expediente.estado === 'ANULADO' ? 'block' :
                                'help_outline'
                                }}
                            </mat-icon>


                            <span>
                                {{ expediente.estado || 'SIN ESTADO' }}
                            </span>
                        </div>



                        <!-- Acciones: toggle + botón -->
                        <div *ngIf="!esAnulado" class="flex items-center gap-6">

                            <!-- Toggle de edición -->
                            <label *ngIf="currentUser?.rol === 'EDICION'" class="flex items-center gap-2 cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" class="sr-only peer" [(ngModel)]="modoEdicionExpediente"
                                        (change)="activarModoEdicion()" />
                                    <div
                                        class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:bg-[#004C77] transition-colors duration-300">
                                    </div>
                                    <div
                                        class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 peer-checked:translate-x-5">
                                    </div>
                                </div>
                                <span class="text-sm text-gray-700">Editar expediente</span>
                            </label>

                            <!-- Botón anular expediente -->
                            <button (click)="confirmarAnulacion()" matTooltip="Anular expediente"
                                class="group flex items-center gap-2 bg-red-50 text-red-700 hover:bg-red-700 hover:text-white px-4 py-2 rounded-md text-sm transition cursor-pointer">

                                <mat-icon
                                    class="!text-red-700 group-hover:!text-white group-focus:!text-white transition-colors duration-300">
                                    cancel
                                </mat-icon>

                                <span class="font-medium">ANULAR EXPEDIENTE</span>
                            </button>

                        </div>
                        <div *ngIf="esAnulado" class="text-gray-500 italic">
                            Expediente anulado. No hay opciones disponibles.
                        </div>
                    </div>


                    <!-- Modo lectura -->
                    <div *ngIf="!modoEdicionExpediente; else formularioEdicion">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-8 text-sm">

                            <div>
                                <p class="text-gray-500 font-medium">Tipo</p>
                                <p class="text-[#004C77] font-semibold">{{ expediente?.tipo }}</p>
                            </div>

                            <div>
                                <p class="text-gray-500 font-medium">Asunto</p>
                                <p class="text-[#004C77] font-semibold">{{ expediente?.asunto }}</p>
                            </div>

                            <div>
                                <p class="text-gray-500 font-medium">Fecha</p>
                                <p class="text-[#004C77] font-semibold">{{ expediente?.fecha }}</p>
                            </div>

                            <div>
                                <p class="text-gray-500 font-medium">Proyecto</p>
                                <p class="text-[#004C77] font-semibold">{{ nombreProyectoSeleccionado || 'Sin asignar'
                                    }}</p>
                            </div>

                            <!-- Usuarios Emisores -->
                            <div>
                                <p class="text-gray-500 font-medium mb-2">Usuarios Emisor</p>
                                <div *ngIf="expediente?.usuariosEmisores?.length" class="space-y-2">
                                    <ng-container *ngFor="let user of expediente?.usuariosEmisores">
                                        <div class="flex items-center gap-2">
                                            <mat-icon inline class="text-[#004C77] cursor-pointer">person</mat-icon>
                                            <span class="font-semibold text-[#004C77]">{{ user.nombre }}</span>
                                            <span class="text-gray-600 text-sm">— {{ user.correo }}</span>
                                        </div>
                                    </ng-container>
                                </div>
                            </div>

                            <!-- Usuarios Destinatarios -->
                            <div>
                                <p class="text-gray-500 font-medium mb-2">Usuarios Destinatario</p>
                                <div *ngIf="expediente?.usuariosDestinatarios?.length" class="space-y-2">
                                    <ng-container *ngFor="let user of expediente?.usuariosDestinatarios">
                                        <div class="flex items-center gap-2">
                                            <mat-icon inline class="text-[#004C77] cursor-pointer">person</mat-icon>
                                            <span class="font-semibold text-[#004C77]">{{ user.nombre }}</span>
                                            <span class="text-gray-600 text-sm">— {{ user.correo }}</span>
                                        </div>
                                    </ng-container>
                                </div>
                            </div>

                            <div>
                                <p class="text-gray-500 font-medium">Reservado</p>
                                <p class="text-[#004C77] font-semibold">{{ expediente?.reservado ? 'Sí' : 'No' }}</p>
                            </div>

                            <div>
                                <p class="text-gray-500 font-medium">Observaciones</p>
                                <p class="text-[#004C77] font-semibold">{{ expediente?.comentario }}</p>
                            </div>

                            <div class="md:col-span-2">
                                <p class="text-gray-500 font-medium mb-2">Referencias</p>
                                <div *ngIf="expediente?.referencias?.length" class="space-y-2">
                                    <ng-container *ngFor="let ref of expediente?.referencias">
                                        <div class="flex items-center gap-2">
                                            <mat-icon inline
                                                class="cursor-pointer text-[#004C77]">description</mat-icon>
                                            <span class="font-semibold text-[#004C77]">{{ ref }}</span>
                                        </div>
                                    </ng-container>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Formulario modo edición -->
                    <ng-template #formularioEdicion>
                        <div class="bg-white rounded-xl shadow p-8 space-y-6">
                            <h2 class="text-xl font-semibold text-[#004C77] mb-4">Editar información del expediente</h2>

                            <form [formGroup]="formularioPaso1" (ngSubmit)="guardarEdicion()"
                                class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">

                                <!-- USUARIO EMISOR -->
                                <div class="md:col-span-2">
                                    <label class="text-sm font-medium text-gray-700 label-obligatorio">Usuario
                                        emisor</label>

                                    <div
                                        class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
                                        <ng-container *ngIf="controlUsuario.value?.length; else placeholderEmisor">
                                            <div *ngFor="let user of controlUsuario.value"
                                                class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                                                {{ user }}
                                                <button type="button" (click)="removerUsuario(user)"
                                                    class="ml-2 hover:text-red-600 cursor-pointer">
                                                    <mat-icon class="text-xs">cancel</mat-icon>
                                                </button>
                                            </div>
                                        </ng-container>
                                        <ng-template #placeholderEmisor>
                                            <span class="text-sm text-gray-400">Ningún usuario seleccionado</span>
                                        </ng-template>
                                    </div>

                                    <div class="flex gap-2 items-start">
                                        <mat-form-field appearance="outline" class="w-full">
                                            <mat-select [formControl]="controlUsuario" multiple class="max-w-full"
                                                (closed)="reiniciarFiltroTipoTo()">
                                                <mat-option class="!cursor-default" disabled>
                                                    <ngx-mat-select-search [formControl]="searchCtrlUsuario"
                                                        placeholderLabel="Buscar..."
                                                        (keydown.enter)="abrirDialogoAgregarUsuario(searchCtrlUsuario.value || '', 'to')"
                                                        noEntriesFoundLabel="No encontrado. ENTER para agregar.">
                                                    </ngx-mat-select-search>
                                                </mat-option>
                                                <div class="flex items-center gap-2 py-2 px-3 bg-gray-50">
                                                    <label class="text-xs text-gray-600">Filtrar por segmento:</label>
                                                    <select [(ngModel)]="filtroTipoUsuarioTo"
                                                        [ngModelOptions]="{ standalone: true }"
                                                        (ngModelChange)="filtrarUsuariosTo()"
                                                        class="text-sm border border-gray-300 rounded px-2 py-1 bg-white focus-within:border-[#004C77] shadow-sm cursor-pointer">
                                                        <option value="">Todos</option>
                                                        <option *ngFor="let tipo of tiposUsuario" [value]="tipo">{{ tipo
                                                            }}</option>
                                                    </select>
                                                </div>
                                                <mat-optgroup *ngFor="let tipo of tiposUsuario" [label]="tipo"
                                                    [hidden]="!mostrarGrupo(tipo)">
                                                    <mat-option
                                                        *ngFor="let user of obtenerUsuariosPorTipo(usuariosFiltradosTo, tipo)"
                                                        [value]="user.nombre">
                                                        {{ user.nombre }} - {{ user.correo }}
                                                    </mat-option>
                                                </mat-optgroup>
                                            </mat-select>
                                        </mat-form-field>

                                        <button type="button" (click)="desenfocarYabrir($event.target, '', 'to')"
                                            class="h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition-colors duration-200"
                                            matTooltip="Agregar nuevo usuario">
                                            <mat-icon>person_add</mat-icon>
                                        </button>
                                    </div>
                                </div>

                                <!-- USUARIO DESTINATARIO -->
                                <div class="md:col-span-2">
                                    <label class="text-sm font-medium text-gray-700 label-obligatorio">Usuario
                                        destinatario (CC)</label>

                                    <div
                                        class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
                                        <ng-container *ngIf="controlUsuarioCc.value?.length; else placeholderCc">
                                            <div *ngFor="let user of controlUsuarioCc.value"
                                                class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                                                {{ user }}
                                                <button type="button" (click)="removerUsuarioCc(user)"
                                                    class="ml-2 hover:text-red-600 cursor-pointer">
                                                    <mat-icon class="text-xs">cancel</mat-icon>
                                                </button>
                                            </div>
                                        </ng-container>
                                        <ng-template #placeholderCc>
                                            <span class="text-sm text-gray-400">Ningún usuario seleccionado</span>
                                        </ng-template>
                                    </div>

                                    <div class="flex gap-2 items-start">
                                        <mat-form-field appearance="outline" class="w-full">
                                            <mat-select [formControl]="controlUsuarioCc" multiple class="max-w-full"
                                                (closed)="reiniciarFiltroTipoCc()">
                                                <mat-option class="!cursor-default" disabled>
                                                    <ngx-mat-select-search [formControl]="searchCtrlCc"
                                                        placeholderLabel="Buscar..."
                                                        (keydown.enter)="abrirDialogoAgregarUsuario(searchCtrlCc.value || '', 'cc')"
                                                        noEntriesFoundLabel="No encontrado. ENTER para agregar.">
                                                    </ngx-mat-select-search>
                                                </mat-option>
                                                <div class="flex items-center gap-2 py-2 px-3 bg-gray-50">
                                                    <label class="text-xs text-gray-600">Filtrar por segmento:</label>
                                                    <select [(ngModel)]="filtroTipoUsuarioCc"
                                                        [ngModelOptions]="{ standalone: true }"
                                                        (ngModelChange)="filtrarUsuariosCc()"
                                                        class="text-sm border border-gray-300 rounded px-2 py-1 bg-white focus-within:border-[#004C77] shadow-sm cursor-pointer">
                                                        <option value="">Todos</option>
                                                        <option *ngFor="let tipo of tiposUsuario" [value]="tipo">{{ tipo
                                                            }}</option>
                                                    </select>
                                                </div>
                                                <mat-optgroup *ngFor="let tipo of tiposUsuario" [label]="tipo"
                                                    [hidden]="!mostrarGrupo(tipo)">
                                                    <mat-option
                                                        *ngFor="let user of obtenerUsuariosPorTipo(usuariosFiltradosCc, tipo)"
                                                        [value]="user.nombre">
                                                        {{ user.nombre }} - {{ user.correo }}
                                                    </mat-option>
                                                </mat-optgroup>
                                            </mat-select>
                                        </mat-form-field>

                                        <button type="button" (click)="desenfocarYabrir($event.target, '', 'cc')"
                                            class="h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition-colors duration-200"
                                            matTooltip="Agregar nuevo usuario">
                                            <mat-icon>person_add</mat-icon>
                                        </button>
                                    </div>
                                </div>

                                <!-- REFERENCIA(S) -->
                                <div class="md:col-span-2">
                                    <label
                                        class="text-sm font-medium text-gray-700 label-obligatorio">Referencia(s)</label>

                                    <!-- Chips seleccionados -->
                                    <div
                                        class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
                                        <ng-container
                                            *ngIf="controlReferencia.value?.length; else placeholderReferencia">
                                            <div *ngFor="let ref of controlReferencia.value"
                                                class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                                                {{ ref }}
                                                <button type="button" (click)="removerReferencia(ref)"
                                                    class="ml-2 text-[#004C77] hover:text-red-600 cursor-pointer transition">
                                                    <mat-icon class="text-xs">cancel</mat-icon>
                                                </button>
                                            </div>
                                        </ng-container>
                                        <ng-template #placeholderReferencia>
                                            <span class="text-sm text-gray-400">Ninguna referencia seleccionada</span>
                                        </ng-template>
                                    </div>

                                    <!-- Select + botón en la misma fila -->
                                    <div class="flex gap-2">
                                        <!-- Select de referencias -->
                                        <mat-form-field appearance="outline" class="flex-1"
                                            matTooltip="Relaciona el expediente con una carta, documento o expediente anterior">
                                            <mat-select [formControl]="controlReferencia" multiple class="max-w-full"
                                                (closed)="reiniciarFiltroTipoReferencia()">

                                                <!-- Búsqueda -->
                                                <mat-option class="!cursor-default" disabled>
                                                    <ngx-mat-select-search [formControl]="searchCtrlReferencia"
                                                        placeholderLabel="Buscar o escribir referencia libre"
                                                        noEntriesFoundLabel="No hay coincidencias, puedes agregarla manualmente">
                                                    </ngx-mat-select-search>
                                                </mat-option>

                                                <!-- Filtro por tipo -->
                                                <div class="flex items-center gap-2 py-2 px-3 bg-gray-50">
                                                    <label class="text-xs text-gray-600 whitespace-nowrap">Filtrar por
                                                        tipo:</label>
                                                    <select [(ngModel)]="filtroTipoReferencia"
                                                        [ngModelOptions]="{ standalone: true }"
                                                        (ngModelChange)="filtrarReferencias()"
                                                        class="text-sm border border-gray-300 rounded px-2 py-1 bg-white focus:border-[#004C77] shadow-sm cursor-pointer">
                                                        <option value="">Todos</option>
                                                        <option *ngFor="let tipo of tiposReferencia" [value]="tipo">{{
                                                            tipo }}</option>
                                                    </select>
                                                </div>

                                                <!-- Opciones agrupadas -->
                                                <mat-optgroup *ngFor="let tipo of tiposReferencia" [label]="tipo">
                                                    <mat-option *ngFor="let ref of obtenerReferenciasPorTipo(tipo)"
                                                        [value]="ref.serie">
                                                        {{ ref.serie }} - {{ ref.asunto }}
                                                    </mat-option>
                                                </mat-optgroup>
                                            </mat-select>
                                        </mat-form-field>

                                        <!-- Botón agregar en línea -->
                                        <button type="button" (click)="abrirDialogoAgregarReferencia()"
                                            class="h-[56px] px-4 bg-[#004C77] text-white rounded-md flex items-center justify-center hover:bg-[#003655] transition-colors duration-200"
                                            matTooltip="Agregar referencia manual">
                                            <mat-icon fontIcon="note_add" class="text-base">note_add</mat-icon>
                                        </button>
                                    </div>
                                </div>



                                <!-- ASUNTO -->
                                <div>
                                    <label class="text-sm font-medium text-gray-700 label-obligatorio">Asunto</label>
                                    <input type="text" formControlName="asunto"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-[#004C77] outline-none" />
                                </div>

                                <!-- FECHA -->
                                <div>
                                    <label class="text-sm font-medium text-gray-700 label-obligatorio">Fecha</label>
                                    <input type="date" formControlName="fecha"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-[#004C77] outline-none" />
                                </div>

                                <!-- PROYECTO -->
                                <div class="md:col-span-2">
                                    <label class="text-sm font-medium text-gray-700 label-obligatorio">Proyecto</label>
                                    <select formControlName="proyecto"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-[#004C77] outline-none">
                                        <option value="" disabled>Seleccione</option>
                                        <option *ngFor="let proyecto of proyectos" [value]="proyecto.id">{{
                                            proyecto.nombre }}</option>
                                    </select>
                                </div>
                                <!-- RESERVADO -->
                                <div class="md:col-span-2">
                                    <label class="text-sm font-medium text-gray-700">Reservado</label>
                                    <div class="flex gap-6 mt-2">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" formControlName="reservado" value="si"
                                                class="accent-[#004C77]" />
                                            <span>Sí</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" formControlName="reservado" value="no"
                                                class="accent-[#004C77]" />
                                            <span>No</span>
                                        </label>
                                    </div>
                                </div>
                                <!-- OBSERVACIONES -->
                                <div class="md:col-span-2">
                                    <label class="text-sm font-medium text-gray-700">Observaciones</label>
                                    <textarea formControlName="comentario" rows="3"
                                        class="w-full px-3 py-2 border border-gray-300 rounded resize-none focus:ring-2 focus:ring-[#004C77] outline-none">
                                    </textarea>
                                </div>
                                <!-- BOTONES -->
                                <div class="md:col-span-2 flex justify-end gap-4 mt-4">
                                    <button type="button" (click)="cancelarEdicion()"
                                        class="cursor-pointer text-[#F36C21] border border-[#F36C21] px-6 py-2 rounded hover:bg-[#F36C21] hover:text-white transition">
                                        Cancelar
                                    </button>
                                    <button type="submit" [disabled]="formularioPaso1.invalid"
                                        class="cursor-pointer bg-[#004C77] text-white px-6 py-2 rounded hover:opacity-90 disabled:bg-gray-300">
                                        Guardar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </ng-template>
                </div>

                <div *ngSwitchCase="'documentos'" class="p-4">
                    <ng-container *ngIf="expediente?.tipo !== 'Emisor'; else documentosFirmaEmisor">

                        <h2 class="text-xl font-semibold text-[#004C77] mb-4">Documentos asociados</h2>
                        <!-- Documentos existentes: listado vertical con edición -->
                        <div class="space-y-4 mb-10">
                            <div [ngClass]="{ 'opacity-50 grayscale cursor-not-allowed': esAnulado }"
                                *ngFor="let doc of expediente?.documentos"
                                class="flex items-center justify-between bg-white border border-gray-300 rounded-lg shadow-sm p-4 gap-6">
                                <!-- Columna: Icono + Datos -->
                                <div class="flex items-start gap-3 min-w-[384px] max-w-[420px]">
                                    <div class="flex flex-col overflow-hidden">
                                        <p class="font-semibold text-gray-800 truncate">{{ doc.nombreArchivo }}</p>
                                        <p class="text-xs italic text-gray-500 mt-0.5 truncate">
                                            {{ doc.tipoDocumento || 'No especificado' }}
                                        </p>
                                        <span class="text-xs text-gray-500 mt-1">{{ formatearPeso(doc['tamaño'])
                                            }}</span>
                                    </div>
                                </div>
                                <!-- Selector -->
                                <div class="flex flex-col w-[180px]">
                                    <label class="text-xs text-gray-600 mb-1 select-none">Tipo de documento</label>
                                    <select [disabled]="esAnulado" [(ngModel)]="doc.tipoDocumento"
                                        (change)="confirmarCambioTipoDocumento(doc)"
                                        class="border border-gray-300 rounded px-2 py-1 text-sm cursor-pointer focus:outline-none focus:ring-1 focus:ring-[#004C77]">
                                        <option value="" disabled>Seleccione tipo</option>
                                        <option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{ tipo }}</option>
                                    </select>
                                </div>
                                <!-- Acciones -->
                                <div class="flex items-center gap-2 pr-1">
                                    <button [disabled]="esAnulado" (click)="toggleVisibilidadDocumento(doc)"
                                        matTooltip="{{ doc.visibleParaExternos ? 'Visible para externos' : 'Oculto para externos' }}"
                                        class="p-1 rounded hover:bg-gray-100 transition cursor-pointer">
                                        <mat-icon color="warn">
                                            {{ doc.visibleParaExternos ? 'visibility' : 'visibility_off' }}
                                        </mat-icon>
                                    </button>

                                    <button (click)="abrirEnNuevaVentana(transformarRutaDocumento(doc.rutaArchivo)!)"
                                        matTooltip="Ver documento"
                                        class="text-[#004C77] hover:text-[#F36C21] cursor-pointer p-1 rounded hover:bg-gray-100 transition">
                                        <mat-icon>picture_as_pdf</mat-icon>
                                    </button>

                                    <button [disabled]="esAnulado" (click)="eliminarDocumentoExistente(doc)"
                                        matTooltip="Eliminar documento"
                                        class="text-red-600 cursor-pointer p-1 rounded hover:bg-gray-100 transition">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <h2 class="text-xl font-semibold text-[#004C77] mb-4">Anexar documentos adicionales</h2>

                        <!-- Drag & Drop para subir archivos -->
                        <div class="border-2 border-dashed rounded-lg p-10 text-center transition-all duration-300"
                            [ngClass]="{
        'border-[#004C77] bg-blue-50': arrastrando && !esAnulado,
        'border-gray-300 bg-gray-100 opacity-50 cursor-not-allowed': esAnulado,
        'border-gray-300 bg-gray-50': !arrastrando && !esAnulado
    }" (dragover)="esAnulado ? $event.preventDefault() : onDragOver($event)"
                            (dragleave)="esAnulado ? $event.preventDefault() : onDragLeave($event)"
                            (drop)="esAnulado ? $event.preventDefault() : onFileDrop($event)">
                            <label for="uploadInput" class="cursor-pointer flex flex-col items-center space-y-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-[#004C77]" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M16 12l-4-4m0 0l-4 4m4-4v12" />
                                </svg>
                                <span class="text-sm text-gray-600">Arrastra archivos aquí o haz clic para
                                    seleccionar</span>
                                <span class="text-xs text-gray-400">Solo PDFs</span>
                            </label>
                            <input [disabled]="esAnulado" id="uploadInput" type="file" accept=".pdf" multiple
                                class="hidden" (change)="onMultipleFilesSelected($event)" />
                        </div>

                        <!-- Documentos nuevos (upload) -->
                        <div class="space-y-2 mt-4" *ngIf="documentosNuevos.length > 0">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Documentos añadidos</h4>

                            <div *ngFor="let doc of documentosNuevos; let i = index"
                                class="flex justify-between items-center bg-white border border-gray-200 shadow-sm rounded px-4 py-3">

                                <div class="flex items-center gap-4 w-full justify-between">
                                    <!-- Icono PDF + nombre + progreso -->
                                    <div class="flex items-center gap-3 w-full">
                                        <svg class="w-5 h-5 text-[#004C77] flex-shrink-0" fill="none"
                                            stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M7 7h10M7 11h10M7 15h10M5 5v14a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2z" />
                                        </svg>
                                        <span class="text-sm text-gray-700 w-[200px] truncate" title="{{ doc.nombre }}">
                                            {{ doc.nombre }}
                                        </span>

                                        <div class="flex-1 flex items-center gap-2">
                                            <span class="text-xs text-gray-500 min-w-[55px] text-right">
                                                {{ formatearPeso(doc.archivo.size) }}
                                            </span>

                                            <div
                                                class="w-full max-w-[150px] h-2 bg-gray-200 rounded-full overflow-hidden">
                                                <div class="h-full bg-[#004C77] transition-all duration-300"
                                                    [style.width.%]="doc.progreso"></div>
                                            </div>

                                            <svg *ngIf="doc.cargado" class="w-5 h-5 text-green-600" fill="none"
                                                stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M5 13l4 4L19 7" />
                                            </svg>
                                        </div>
                                    </div>

                                    <!-- Tipo de documento -->
                                    <div class="w-[180px]">
                                        <label class="text-xs text-gray-500 block mb-1 select-none">Tipo de
                                            documento</label>
                                        <select [(ngModel)]="doc.tipoDocumento" [ngModelOptions]="{ standalone: true }"
                                            class="cursor-pointer w-full px-2 py-1 text-sm border border-gray-300 rounded"
                                            required>
                                            <option value="" disabled>Seleccione</option>
                                            <option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{ tipo }}
                                            </option>
                                        </select>
                                    </div>

                                    <!-- Acciones -->
                                    <div class="flex gap-3 text-sm items-center">

                                        <button
                                            [matTooltip]="doc.visibleParaExternos ? 'Visible para externos' : 'Oculto para externos'"
                                            (click)="alternarVisibilidad(i)"
                                            class="cursor-pointer p-1 rounded hover:bg-gray-100 transition">
                                            <svg *ngIf="doc.visibleParaExternos" class="w-5 h-5 text-[#F36C21]"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7s-8.268-2.943-9.542-7z" />
                                            </svg>
                                            <svg *ngIf="!doc.visibleParaExternos" class="w-5 h-5 text-gray-400"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.969 9.969 0 012.386-3.872M10.6 4.184a9.957 9.957 0 012.268-.184c4.477 0 8.268 2.943 9.542 7a9.97 9.97 0 01-4.293 5.187M3 3l18 18" />
                                            </svg>
                                        </button>

                                        <button (click)="verDocumentoNuevo(i)" matTooltip="Visualizar Documento"
                                            class="text-[#004C77] hover:text-[#F36C21] cursor-pointer p-1 rounded hover:bg-gray-100 transition">
                                            <mat-icon>picture_as_pdf</mat-icon>
                                        </button>

                                        <button (click)="eliminarDocumento(i)" matTooltip="Eliminar Documento"
                                            class="text-red-600 hover:text-red-800 cursor-pointer p-1 rounded hover:bg-gray-100 transition">
                                            <mat-icon>delete</mat-icon>
                                        </button>

                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end mt-4">
                            <button (click)="subirDocumentosAdicionales()"
                                [disabled]="documentosNuevos.length === 0 || !todosLosDocumentosTienenTipo()"
                                class="cursor-pointer bg-[#004C77] text-white px-6 py-2 rounded hover:opacity-90 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                Subir documentos adicionales
                            </button>
                        </div>
                    </ng-container>
                    <ng-template #documentosFirmaEmisor>
                        <div class="mb-4 flex items-center justify-between">
                            <h2 class="text-xl font-semibold text-[#004C77]">Documentos y flujos de firma</h2>
                            <!-- Toggle de edición para flujos de firma -->
                            <label *ngIf="currentUser?.rol === 'EDICION'" class="flex items-center gap-2 cursor-pointer mb-4">
                                <div class="relative">
                                    <input type="checkbox" class="sr-only peer" [(ngModel)]="modoEdicionFlujos" />
                                    <div
                                        class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:bg-[#004C77] transition-colors duration-300">
                                    </div>
                                    <div
                                        class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 peer-checked:translate-x-5">
                                    </div>
                                </div>
                                <span class="text-sm text-gray-700">Editar flujos de firma</span>
                            </label>

                        </div>
                        <!-- Selector de tipo de flujo de firma mejorado -->
                        <div class="bg-white border border-gray-300 shadow-sm rounded-xl px-6 py-6 mb-6">
                            <h2 class="py-3 text-xl font-semibold text-[#004C77]">Tipo de flujo de firma:</h2>

                            <div class="flex gap-2 bg-gray-100 rounded-full w-fit p-1 shadow-inner"
                                [class.pointer-events-none]="!modoEdicionFlujos">
                                <!-- Botón: Por documento -->
                                <button type="button" [disabled]="!modoEdicionFlujos"
                                    (click)="modoFlujoFirma = 'individual'" [ngClass]="{
        'bg-white shadow text-[#004C77] font-semibold': modoFlujoFirma === 'individual',
        'text-gray-600 hover:text-[#004C77]': modoFlujoFirma !== 'individual'
      }" class="cursor-pointer px-4 py-1.5 text-sm rounded-full transition-all duration-200">
                                    Niveles por documento
                                </button>

                                <!-- Botón: General -->
                                <button type="button" [disabled]="!modoEdicionFlujos"
                                    (click)="modoFlujoFirma = 'general'" [ngClass]="{
        'bg-white shadow text-[#004C77] font-semibold': modoFlujoFirma === 'general',
        'text-gray-600 hover:text-[#004C77]': modoFlujoFirma !== 'general'
      }" class="cursor-pointer px-4 py-1.5 text-sm rounded-full transition-all duration-200">
                                    Niveles generales
                                </button>
                            </div>
                        </div>
                        <!-- Línea divisora -->
                        <hr class="mt-6 mb-6 border-t border-gray-300">
                        <h2 class="text-xl font-semibold text-[#004C77]">Documentos del expediente base</h2>
                        <div *ngIf="documentosDeFlujo.length === 0" class="text-sm text-gray-500 italic mb-4">
                            No se han encontrado documentos relacionados del expediente base.
                        </div>
                        <!-- Documentos existentes -->
                        <div *ngFor="let doc of documentosDeFlujo; let i = index"
                            class="my-4 space-y-4 items-center bg-white border border-gray-200 shadow-sm rounded px-4 py-3">
                            <div class="flex flex-col md:flex-row justify-between gap-4 items-start md:items-center">
                                <div class="flex items-center gap-3 w-full">
                                    <svg class="w-5 h-5 text-[#004C77] flex-shrink-0" fill="none" stroke="currentColor"
                                        stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M7 7h10M7 11h10M7 15h10M5 5v14a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2 2H7a2 2 0 00-2 2z" />
                                    </svg>
                                    <span class="text-sm text-gray-700 w-[200px] truncate">
                                        {{ doc.nombreArchivo }}
                                    </span>
                                    <span class="text-xs text-gray-500 mt-1">{{ formatearPeso(doc['tamaño'])
                                        }}</span>
                                </div>
                                <!-- Tipo solo lectura -->
                                <div class="w-[180px]">
                                    <label class="text-xs text-gray-500 block mb-1">Tipo de documento</label>
                                    <input type="text"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded bg-gray-100"
                                        [value]="doc.tipoDocumento" readonly />
                                </div>
                                <!-- Requiere firma -->
                                <div class="flex flex-col items-center gap-1 min-w-[100px] whitespace-nowrap">
                                    <label class="text-xs text-gray-500">¿Requiere firma?</label>
                                    <input type="checkbox" [disabled]="!modoEdicionFlujos"
                                        [(ngModel)]="doc.requiereFirma"
                                        (ngModelChange)="actualizarEstadoBotonRegistro()"
                                        class="accent-[#004C77] w-4 h-4 cursor-pointer">
                                </div>

                                <!-- Botón Ver -->
                                <div class="flex gap-3 text-sm">
                                    <button (click)="abrirEnNuevaVentana(transformarRutaDocumento(doc.rutaArchivo)!)"
                                        matTooltip="Ver documento"
                                        class="text-[#004C77] hover:underline cursor-pointer">Ver</button>
                                </div>
                            </div>
                            <div *ngIf="modoFlujoFirma === 'individual'&& doc.requiereFirma">
                                <div class="items-center bg-white border border-gray-200 shadow-sm rounded px-4 py-3">
                                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Flujo de firma para {{
                                        doc.nombreArchivo }} </h3>
                                    <div *ngFor="let nivel of doc.nivelesFirma; let j = index" class="mb-3">
                                        <!-- Fecha límite de firma -->
                                        <div class="mb-3">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="text-sm font-medium text-[#004C77]">Nivel {{ j + 1
                                                    }}</span>
                                                <button type="button" *ngIf="modoEdicionFlujos"
                                                    [disabled]="!modoEdicionFlujos" (click)="eliminarNivel(doc, j)"
                                                    matTooltip="Eliminar Nivel"
                                                    class="cursor-pointer text-red-600 text-xs hover:underline">
                                                    Eliminar nivel
                                                </button>
                                            </div>
                                            <div class="mt-4 pb-4 w-full">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    Fecha límite de firma
                                                </label>
                                                <div class="relative">
                                                    <input type="date" [disabled]="!modoEdicionFlujos"
                                                        [(ngModel)]="nivel.fechaLimite"
                                                        [min]="doc.nivelesFirma[j - 1]?.fechaLimite || minDateString"
                                                        (ngModelChange)="validarFechasEnCascada(doc.nivelesFirma)"
                                                        class="w-full ..." placeholder="dd/mm/aaaa" />

                                                </div>
                                            </div>
                                            <!-- Chips de usuarios seleccionados -->
                                            <div
                                                class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
                                                <ng-container
                                                    *ngIf="nivel.controlUsuarios.value?.length; else placeholderNivel">
                                                    <div *ngFor="let user of nivel.controlUsuarios.value"
                                                        class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                                                        {{ user }}
                                                        <button type="button" [disabled]="!modoEdicionFlujos"
                                                            (click)="removerUsuarioNivel(user, nivel)"
                                                            *ngIf="modoEdicionFlujos"
                                                            class="ml-2 hover:text-red-600 cursor-pointer">
                                                            <mat-icon class="text-xs">cancel</mat-icon>
                                                        </button>
                                                    </div>
                                                </ng-container>
                                                <ng-template #placeholderNivel>
                                                    <span class="text-sm text-gray-400">Ningún usuario
                                                        seleccionado</span>
                                                </ng-template>
                                            </div>
                                            <!-- Selector -->
                                            <div class="flex gap-2 items-start" [class.opacity-50]="!modoEdicionFlujos"
                                                [class.pointer-events-none]="!modoEdicionFlujos">
                                                <mat-form-field appearance="outline" class="w-full"
                                                    matTooltip="Selecciona usuarios internos para este nivel">
                                                    <mat-select [formControl]="nivel.controlUsuarios" multiple
                                                        class="max-w-full" (closed)="reiniciarFiltroInternos(nivel)">
                                                        <mat-option class="!cursor-default" disabled>
                                                            <ngx-mat-select-search [formControl]="nivel.searchControl"
                                                                placeholderLabel="Buscar usuario..."
                                                                (keydown.enter)="abrirDialogoAgregarUsuario(nivel.searchControl.value || '', 'nivel')"
                                                                noEntriesFoundLabel="No encontrado. Presiona ENTER para registrar nuevo usuario interno">
                                                            </ngx-mat-select-search>
                                                        </mat-option>

                                                        <mat-optgroup *ngFor="let tipo of tiposUsuarioFirma"
                                                            [label]="tipo"
                                                            [hidden]="!mostrarGrupoInternoTipo(tipo, nivel)">
                                                            <mat-option
                                                                *ngFor="let user of obtenerUsuariosPorTipoFirma(nivel.usuariosFiltrados, tipo)"
                                                                [value]="user.nombre">
                                                                {{ user.nombre }} - {{ user.correo }}
                                                            </mat-option>
                                                        </mat-optgroup>
                                                    </mat-select>

                                                </mat-form-field>

                                                <button type="button" #btnAgregarUsuarioNivel
                                                    (click)="desenfocarYabrir(btnAgregarUsuarioNivel, '', 'nivel')"
                                                    class="cursor-pointer h-[56px] min-h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition-colors duration-200"
                                                    matTooltip="Agregar nuevo usuario interno">
                                                    <mat-icon class="text-base">person_add</mat-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" [disabled]="!doc.requiereFirma" *ngIf="modoEdicionFlujos"
                                    matTooltip="Agregar Nivel" (click)="agregarNivel(doc)"
                                    class="cursor-pointer text-sm text-[#004C77] hover:underline px-4">
                                    + Agregar nivel para {{ doc.nombreArchivo }}
                                </button>
                            </div>
                        </div>
                        <!-- NIVELES GENERALES DE FIRMA (si está seleccionado el modo general) -->


                        <!-- Divider -->
                        <hr class="my-6 border-gray-300" />
                        <!-- NUEVOS DOCUMENTOS (solo para tipo Emisor) -->
                        <div class="space-y-6">
                            <h2 class=" text-xl font-semibold text-[#004C77]">Carga de nuevos documentos del expediente
                            </h2>

                            <!-- Drag & Drop -->
                            <div class="border-2 border-dashed rounded-lg p-10 text-center transition-all duration-300"
                                [ngClass]="{
    'border-[#004C77] bg-blue-50': arrastrando,
    'border-gray-300 bg-gray-50': !arrastrando
  }" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onFileDrop($event)"
                                [class.opacity-50]="!modoEdicionFlujos"
                                [class.pointer-events-none]="!modoEdicionFlujos">
                                <label for="uploadInputEmisor"
                                    class="cursor-pointer flex flex-col items-center space-y-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-[#004C77]" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M16 12l-4-4m0 0l-4 4m4-4v12" />
                                    </svg>
                                    <span class="text-sm text-gray-600">Arrastra tus archivos aquí o haz clic para
                                        seleccionar</span>
                                    <span class="text-xs text-gray-400">Archivos permitidos: PDF</span>
                                </label>
                                <input id="uploadInputEmisor" type="file" accept=".pdf" multiple class="hidden"
                                    (change)="onMultipleFilesSelectedx($event)" />
                            </div>

                            <!-- Lista de nuevos documentos -->
                            <div *ngIf="documentosNuevos.length > 0" class="space-y-4">
                                <h4 class="text-sm font-semibold text-gray-700">Documentos añadidos</h4>

                                <div *ngFor="let doc of documentosNuevos; let i = index"
                                    class="bg-white border border-gray-200 shadow-sm rounded px-4 py-3 space-y-4">
                                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                                        <!-- Nombre y progreso -->
                                        <div class="flex items-center gap-3 w-full">
                                            <svg class="w-5 h-5 text-[#004C77] flex-shrink-0" fill="none"
                                                stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M7 7h10M7 11h10M7 15h10M5 5v14a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2z" />
                                            </svg>
                                            <span class="text-sm text-gray-700 w-[200px] truncate">
                                                {{ doc.nombre }}
                                            </span>
                                            <div class="flex-1 flex items-center gap-2">
                                                <span class="text-xs text-gray-500 min-w-[55px] text-right">
                                                    {{ formatearPeso(doc.archivo.size) }}
                                                </span>
                                                <div
                                                    class="w-full max-w-[150px] h-2 bg-gray-200 rounded-full overflow-hidden">
                                                    <div class="h-full bg-[#004C77] transition-all duration-300"
                                                        [style.width.%]="doc.progreso"></div>
                                                </div>
                                                <svg *ngIf="doc.cargado" class="w-5 h-5 text-green-600" fill="none"
                                                    stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M5 13l4 4L19 7" />
                                                </svg>
                                            </div>
                                        </div>

                                        <!-- Tipo -->
                                        <div class="w-[180px]">
                                            <label class="text-xs text-gray-500 block mb-1">Tipo de documento</label>
                                            <select [(ngModel)]="doc.tipoDocumento"
                                                [ngModelOptions]="{ standalone: true }"
                                                class="cursor-pointer w-full px-2 py-1 text-sm border border-gray-300 rounded"
                                                required>
                                                <option value="" disabled>Seleccione</option>
                                                <option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{ tipo }}
                                                </option>
                                            </select>
                                        </div>

                                        <!-- Visibilidad + Acciones -->
                                        <div class="flex gap-3 text-sm">
                                            <button
                                                [matTooltip]="doc.visibleParaExternos ? 'Visible para externos' : 'Oculto para externos'"
                                                (click)="alternarVisibilidadNuevo(i)"
                                                class="cursor-pointer p-1 rounded hover:bg-gray-100 transition">
                                                <svg *ngIf="doc.visibleParaExternos" class="w-5 h-5 text-[#F36C21]"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                                    stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7s-8.268-2.943-9.542-7z" />
                                                </svg>
                                                <svg *ngIf="!doc.visibleParaExternos" class="w-5 h-5 text-gray-400"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                                    stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.969 9.969 0 012.386-3.872M10.6 4.184a9.957 9.957 0 012.268-.184c4.477 0 8.268 2.943 9.542 7a9.97 9.97 0 01-4.293 5.187M3 3l18 18" />
                                                </svg>
                                            </button>

                                            <button (click)="verDocumentoNuevo(i)" matTooltip="Visualizar Documento"
                                                class="text-[#004C77] hover:underline cursor-pointer">Ver</button>
                                            <button (click)="eliminarDocumentoNuevo(i)" matTooltip="Eliminar Documento"
                                                class="text-red-600 hover:underline cursor-pointer">Eliminar</button>
                                        </div>
                                    </div>
                                    <!-- BLOQUE DE FLUJO DE FIRMA PARA DOCUMENTOS NUEVOS -->
                                    <div *ngIf="modoFlujoFirma === 'individual'" class="mt-4 w-full pt-4">
                                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Flujo de firma para {{
                                            doc.nombre }}</h3>

                                        <div *ngFor="let nivel of doc.nivelesFirma; let j = index"
                                            class="mb-4 rounded p-3 bg-gray-50">
                                            <!-- Cabecera -->
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-sm font-medium text-[#004C77]">Nivel {{ j + 1
                                                    }}</span>
                                                <button type="button" (click)="eliminarNivel(doc, j)"
                                                    matTooltip="Eliminar Nivel"
                                                    class="cursor-pointer text-red-600 text-xs hover:underline">
                                                    Eliminar nivel
                                                </button>
                                            </div>

                                            <!-- Fecha límite -->
                                            <div class="mb-3">
                                                <label class="block text-sm text-gray-700 mb-1">Fecha límite</label>
                                                <input type="date" [(ngModel)]="nivel.fechaLimite"
                                                    [disabled]="!modoEdicionFlujos"
                                                    [min]="doc.nivelesFirma[j - 1]?.fechaLimite || minDateString"
                                                    (ngModelChange)="validarFechasEnCascada(doc.nivelesFirma)"
                                                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm" />
                                            </div>

                                            <!-- Chips de usuarios -->
                                            <div
                                                class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
                                                <ng-container
                                                    *ngIf="nivel.controlUsuarios.value?.length; else placeholderNivelNuevo">
                                                    <div *ngFor="let user of nivel.controlUsuarios.value"
                                                        class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                                                        {{ user }}
                                                        <button type="button" (click)="removerUsuarioNivel(user, nivel)"
                                                            class="ml-2 hover:text-red-600 cursor-pointer">
                                                            <mat-icon class="text-xs">cancel</mat-icon>
                                                        </button>
                                                    </div>
                                                </ng-container>
                                                <ng-template #placeholderNivelNuevo>
                                                    <span class="text-sm text-gray-400">Ningún usuario
                                                        seleccionado</span>
                                                </ng-template>
                                            </div>

                                            <!-- Selector -->
                                            <div class="flex gap-2 items-start">
                                                <mat-form-field appearance="outline" class="w-full"
                                                    matTooltip="Selecciona usuarios internos">
                                                    <mat-select [formControl]="nivel.controlUsuarios" multiple
                                                        class="max-w-full" (closed)="reiniciarFiltroInternos(nivel)">
                                                        <mat-option class="!cursor-default" disabled>
                                                            <ngx-mat-select-search [formControl]="nivel.searchControl"
                                                                placeholderLabel="Buscar usuario..."
                                                                (keydown.enter)="abrirDialogoAgregarUsuario(nivel.searchControl.value || '', 'nivel')"
                                                                noEntriesFoundLabel="No encontrado. Presiona ENTER para registrar nuevo usuario interno">
                                                            </ngx-mat-select-search>
                                                        </mat-option>

                                                        <!-- Usuarios agrupados -->
                                                        <mat-optgroup *ngFor="let tipo of tiposUsuarioFirma"
                                                            [label]="tipo"
                                                            [hidden]="!mostrarGrupoInternoTipo(tipo, nivel)">
                                                            <mat-option
                                                                *ngFor="let user of obtenerUsuariosPorTipoFirma(nivel.usuariosFiltrados, tipo)"
                                                                [value]="user.nombre">
                                                                {{ user.nombre }} - {{ user.correo }}
                                                            </mat-option>
                                                        </mat-optgroup>
                                                    </mat-select>
                                                </mat-form-field>

                                                <!-- Botón Agregar Usuario -->
                                                <button type="button" #btnAgregarUsuarioNuevo
                                                    (click)="desenfocarYabrir(btnAgregarUsuarioNuevo, '', 'nivel')"
                                                    class="cursor-pointer h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition"
                                                    matTooltip="Agregar nuevo usuario interno">
                                                    <mat-icon class="text-base">person_add</mat-icon>
                                                </button>
                                            </div>
                                        </div>

                                        <button type="button" matTooltip="Agregar Nivel" (click)="agregarNivel(doc)"
                                            class="cursor-pointer text-sm text-[#004C77] hover:underline mt-2">
                                            + Agregar nivel para {{ doc.nombre }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-6 border-gray-300" />
                        <div *ngIf="modoFlujoFirma === 'general'"
                            class="mt-6 items-center bg-white border border-gray-200 shadow-sm rounded px-4 py-3">
                            <h3 class="text-sm font-semibold text-gray-700 mb-2">Flujo de firma general para todos los
                                documentos</h3>

                            <div *ngFor="let nivel of nivelesFirmaGenerales; let j = index" class="mb-3">
                                <div class="mb-3">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-sm font-medium text-[#004C77]">Nivel {{ j + 1 }}</span>
                                        <button type="button" *ngIf="modoEdicionFlujos"
                                            (click)="eliminarNivelGeneral(j)" matTooltip="Eliminar Nivel"
                                            class="cursor-pointer text-red-600 text-xs hover:underline">
                                            Eliminar nivel
                                        </button>
                                    </div>
                                    <div class="mt-4 pb-4 w-full">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Fecha límite de firma
                                        </label>

                                        <div class="relative">
                                            <input type="date" [(ngModel)]="nivel.fechaLimite"
                                                [disabled]="!modoEdicionFlujos"
                                                [min]="nivelesFirmaGenerales[j - 1]?.fechaLimite || minDateString"
                                                (ngModelChange)="validarFechasEnCascada(nivelesFirmaGenerales)"
                                                class="w-full ..." placeholder="dd/mm/aaaa" />
                                        </div>
                                    </div>
                                    <!-- Chips de usuarios seleccionados -->
                                    <div
                                        class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
                                        <ng-container
                                            *ngIf="nivel.controlUsuarios.value?.length; else placeholderNivelGeneral">
                                            <div *ngFor="let user of nivel.controlUsuarios.value"
                                                class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                                                {{ user }}
                                                <button type="button" *ngIf="modoEdicionFlujos"
                                                    [disabled]="!modoEdicionFlujos"
                                                    (click)="removerUsuarioNivelGeneral(user, nivel)"
                                                    class="ml-2 hover:text-red-600 cursor-pointer">
                                                    <mat-icon class="text-xs">cancel</mat-icon>
                                                </button>
                                            </div>
                                        </ng-container>
                                        <ng-template #placeholderNivelGeneral>
                                            <span class="text-sm text-gray-400">Ningún usuario seleccionado</span>
                                        </ng-template>
                                    </div>

                                    <!-- Selector -->
                                    <div class="flex gap-2 items-start" [class.opacity-50]="!modoEdicionFlujos"
                                        [class.pointer-events-none]="!modoEdicionFlujos">
                                        <mat-form-field appearance="outline" class="w-full"
                                            matTooltip="Selecciona usuarios internos para este nivel">
                                            <mat-select [formControl]="nivel.controlUsuarios" multiple
                                                class="max-w-full" (closed)="reiniciarFiltroInternos(nivel)">
                                                <mat-option class="!cursor-default" disabled>
                                                    <ngx-mat-select-search [formControl]="nivel.searchControl"
                                                        placeholderLabel="Buscar usuario..."
                                                        (keydown.enter)="abrirDialogoAgregarUsuario(nivel.searchControl.value || '', 'nivel')"
                                                        noEntriesFoundLabel="No encontrado. Presiona ENTER para registrar nuevo usuario interno">
                                                    </ngx-mat-select-search>
                                                </mat-option>
                                                <mat-optgroup *ngFor="let tipo of tiposUsuarioFirma" [label]="tipo"
                                                    [hidden]="!mostrarGrupoInternoTipo(tipo, nivel)">
                                                    <mat-option
                                                        *ngFor="let user of obtenerUsuariosPorTipoFirma(nivel.usuariosFiltrados, tipo)"
                                                        [value]="user.nombre">
                                                        {{ user.nombre }} - {{ user.correo }}
                                                    </mat-option>
                                                </mat-optgroup>
                                            </mat-select>
                                        </mat-form-field>

                                        <button type="button" #btnAgregarUsuarioNivel
                                            (click)="desenfocarYabrir(btnAgregarUsuarioNivel, '', 'nivel')"
                                            class="cursor-pointer h-[56px] min-h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition-colors duration-200"
                                            matTooltip="Agregar nuevo usuario interno">
                                            <mat-icon class="text-base">person_add</mat-icon>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <button type="button" matTooltip="Agregar Nivel" *ngIf="modoEdicionFlujos"
                                (click)="agregarNivelGeneral()"
                                class="cursor-pointer text-sm text-[#004C77] hover:underline mt-2">
                                + Agregar nivel general
                            </button>
                        </div>
                        <div *ngIf="modoEdicionFlujos" class="flex justify-end gap-4 mt-6">

                            <button (click)="cancelarEdicionFlujos()"
                                class="cursor-pointer text-[#F36C21] border border-[#F36C21] px-6 py-2 rounded hover:bg-[#F36C21] hover:text-white transition">
                                Cancelar
                            </button>
                            <button (click)="guardarCambiosFlujos()"
                                class="cursor-pointer bg-[#004C77] text-white px-6 py-2 rounded hover:opacity-90 disabled:bg-gray-300">
                                Guardar
                            </button>

                        </div>


                    </ng-template>
                </div>

                <!-- CARGO -->
                <div *ngSwitchCase="'cargo'" class="p-4 space-y-6">
                    <!-- Top section -->
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6">

                        <!-- Card -->
                        <div class="bg-white border border-gray-300 rounded-lg shadow-md p-5 flex-1">
                            <ng-container *ngIf="expediente?.cargo; else noCargo">
                                <h3 class="text-lg font-semibold text-[#004C77] mb-3">Cargo generado actual</h3>

                                <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-800">
                                    <div class="flex items-center gap-1">
                                        <mat-icon
                                            class="align-middle text-base leading-none">confirmation_number</mat-icon>
                                        <strong>Código:</strong> {{ expediente.cargo.codigo || 'Sin código' }}
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <mat-icon class="align-middle text-base leading-none">calendar_today</mat-icon>
                                        <strong>Fecha:</strong> {{ expediente.cargo.fecha }}
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <mat-icon class="align-middle text-base leading-none">schedule</mat-icon>
                                        <strong>Hora:</strong> {{ expediente.cargo.hora }}
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <ng-container
                                            *ngIf="transformarRutaCargo(expediente.cargo.archivo); else sinArchivo">
                                            <button
                                                (click)="abrirEnNuevaVentana(transformarRutaCargo(expediente.cargo.archivo)!)"
                                                class="text-[#004C77] hover:text-[#F36C21] cursor-pointer flex items-center gap-1"
                                                matTooltip="Ver documento PDF">
                                                <mat-icon>description</mat-icon>
                                                Ver documento
                                            </button>

                                        </ng-container>
                                        <ng-template #sinArchivo>
                                            <span class="text-gray-400 italic flex items-center gap-1">
                                                <mat-icon>block</mat-icon> Sin archivo
                                            </span>
                                        </ng-template>
                                    </div>
                                </div>
                            </ng-container>

                            <ng-template #noCargo>
                                <p class="text-gray-500 italic text-center">No se ha generado ningún cargo aún.</p>
                            </ng-template>
                        </div>

                        <!-- Botón -->
                        <!-- Botón -->
                        <button [disabled]="esAnulado"
                            class="px-4 py-2 rounded-md shadow flex items-center gap-2 transition-all w-full md:w-auto"
                            [ngClass]="{
        'bg-[#004C77] hover:bg-[#F36C21] text-white cursor-pointer': !esAnulado,
        'bg-gray-300 text-gray-500 cursor-not-allowed': esAnulado
    }" matTooltip="Generar un nuevo cargo" (click)="!esAnulado && abrirDialogoCargo()">
                            <mat-icon class="!text-white">add_circle_outline</mat-icon>
                            <span>Generar nuevo Cargo</span>
                        </button>


                    </div>

                    <!-- HISTORIAL -->
                    <div>
                        <h4 class="text-[#004C77] font-semibold text-base mb-3">Historial de Cargos</h4>
                        <ng-container *ngIf="historialCargos.length > 1; else noHistorial">
                            <div
                                class="space-y-2 max-h-[320px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                                <div *ngFor="let cargo of historialCargos.slice(1)"
                                    class="bg-white border border-gray-200 rounded-md px-4 py-3 flex justify-between items-center text-sm text-gray-800">

                                    <div class="flex gap-6 items-center flex-wrap">
                                        <span class="flex items-center gap-1">
                                            <mat-icon class="text-base">confirmation_number</mat-icon>
                                            <strong>Código:</strong> {{ cargo.codigo }}
                                        </span>
                                        <span class="flex items-center gap-1">
                                            <mat-icon class="text-base">calendar_today</mat-icon>
                                            <strong>Fecha:</strong> {{ cargo.fecha }}
                                        </span>
                                        <span class="flex items-center gap-1">
                                            <mat-icon class="text-base">schedule</mat-icon>
                                            <strong>Hora:</strong> {{ cargo.hora }}
                                        </span>
                                    </div>

                                    <div>
                                        <ng-container
                                            *ngIf="transformarRutaCargo(cargo.archivoPath); else sinArchivoHist">
                                            <button
                                                (click)="abrirEnNuevaVentana(transformarRutaCargo(cargo.archivoPath)!)"
                                                class="text-[#004C77] hover:text-[#F36C21] cursor-pointer flex items-center gap-1"
                                                matTooltip="Ver documento">
                                                <mat-icon>description</mat-icon>
                                                Ver documento
                                            </button>

                                        </ng-container>
                                        <ng-template #sinArchivoHist>
                                            <span class="text-gray-400 italic flex items-center gap-1">
                                                <mat-icon>block</mat-icon> Sin archivo
                                            </span>
                                        </ng-template>
                                    </div>
                                </div>
                            </div>
                        </ng-container>

                        <ng-template #noHistorial>
                            <p class="text-gray-500 italic">No hay cargos anteriores aún.</p>
                        </ng-template>
                    </div>
                </div>

                <!-- Estado del Proceso -->
                <!-- Estado del Proceso (Receptor) -->
                <div *ngSwitchCase="'estado'" class="p-6 bg-white rounded-lg shadow">

                    <ng-container *ngIf="expediente?.tipo === 'Receptor'; else vistaAnterior">
                        <h3 class="text-lg font-semibold text-[#004C77] mb-6">Estado del Proceso</h3>
                        <!-- Leyenda de colores -->
                        <div class="flex items-center justify-end gap-6 text-sm text-gray-600 mb-6">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-[#129490] border border-[#129490]"></div>
                                <span class="text-gray-700">Completado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-[#F36C21] border border-[#F36C21]"></div>
                                <span class="text-gray-700">En curso</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-[#A0AEC0] border border-[#A0AEC0]"></div>
                                <span class="text-gray-700">Pendiente</span>
                            </div>
                        </div>

                        <!-- Línea de pasos -->
                        <div class="relative flex items-center justify-between max-w-3xl mx-auto h-20">

                            <!-- Línea de conexión (centrada perfectamente) -->
                            <div
                                class="absolute top-1/4 left-[6%] right-[6%] h-1 bg-gray-300 z-0 transform -translate-y-1/2">
                            </div>

                            <!-- Paso 1: Creación -->
                            <div class="flex flex-col items-center z-10 cursor-pointer"
                                (click)="etapaSeleccionada = 'CREACION'">
                                <div class="w-12 h-12 rounded-full border-4 flex items-center justify-center font-bold text-white transition"
                                    [ngClass]="{
  'bg-[#129490] border-[#129490]': [1, 2, 3, 4].includes(estadoProcesoIndex),
  'bg-[#F36C21] border-[#F36C21]': estadoProcesoIndex === 0,
  'bg-[#A0AEC0] border-[#A0AEC0]': estadoProcesoIndex < 0
}">
                                    1
                                </div>
                                <span
                                    class="mt-2 text-sm text-center text-gray-700 font-medium leading-tight">Creación<br>Expediente</span>
                            </div>

                            <!-- Paso 2 -->
                            <div class="flex flex-col items-center z-10 cursor-pointer"
                                (click)="etapaSeleccionada = 'APROBACION'">
                                <div class="w-12 h-12 rounded-full border-4 flex items-center justify-center font-bold text-white transition"
                                    [ngClass]="{
      'bg-[#129490] border-[#129490]': estadoProcesoIndex === 2 || estadoProcesoIndex === 3,
      'bg-[#F36C21] border-[#F36C21]': estadoProcesoIndex === 1 || estadoProcesoIndex === 4,
      'bg-[#A0AEC0] border-[#A0AEC0]': estadoProcesoIndex < 1
    }">
                                    2
                                </div>
                                <span class="mt-2 text-sm text-center text-gray-700 font-medium leading-tight">
                                    Aprobación<br>Expediente
                                </span>
                            </div>

                            <!-- Paso 3 -->
                            <div class="flex flex-col items-center z-10 cursor-pointer"
                                (click)="etapaSeleccionada = 'CARGO'">
                                <div class="w-12 h-12 rounded-full border-4 flex items-center justify-center font-bold text-white transition"
                                    [ngClass]="{
      'bg-[#129490] border-[#129490]': estadoProcesoIndex === 3 || estadoProcesoIndex === 4,
      'bg-[#A0AEC0] border-[#A0AEC0]': estadoProcesoIndex < 3
    }">
                                    3
                                </div>
                                <span class="mt-2 text-sm text-center text-gray-700 font-medium leading-tight">
                                    Cargo<br>Generado
                                </span>
                            </div>

                        </div>


                        <!-- Detalles de la etapa -->
                        <div class="mt-10 bg-gray-50 border border-gray-200 rounded-lg p-6 text-sm text-gray-700">
                            <ng-container [ngSwitch]="etapaSeleccionada">
                                <p *ngSwitchCase="'CREACION'">
                                    <strong>Creación:</strong> El expediente fue registrado en el sistema y está
                                    esperando revisión.
                                </p>
                                <p *ngSwitchCase="'APROBACION'">
                                    <strong>Aprobación:</strong> El expediente está en proceso de revisión y debe ser
                                    aprobado por las personas asignadas.
                                </p>
                                <p *ngSwitchCase="'CARGO'">
                                    <strong>Cargo:</strong> El expediente ya cuenta con un documento de cargo generado
                                    que formaliza su entrega.
                                </p>
                                <p *ngSwitchDefault class="italic text-gray-500">
                                    Selecciona una etapa del proceso para ver su detalle.
                                </p>
                            </ng-container>
                        </div>
                    </ng-container>

                    <!-- Vista anterior (para emisores u otros) -->
                    <ng-template #vistaAnterior>
                        <h3 class="text-lg font-semibold text-[#004C77] mb-6">Línea de tiempo del proceso</h3>
                        <div class="relative pl-10">
                            <div class="absolute left-6 top-0 bottom-0 w-0.5 bg-[#004C77]"></div>
                            <div *ngFor="let etapa of expediente.estadoProceso; let i = index" class="relative mb-8">
                                <div class="absolute left-5 w-4 h-4 rounded-full border-4 z-10"
                                    style="top: calc(50% - 0.5rem);"
                                    [ngClass]="etapa.completado ? 'bg-[#004C77] border-[#004C77]' : 'bg-white border-gray-400'">
                                </div>
                                <div
                                    class="ml-12 bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-all">
                                    <p class="font-semibold text-[#004C77]">{{ etapa.nombre }}</p>
                                    <p class="text-sm text-gray-500 mt-1">
                                        {{ etapa.fecha }} — {{ etapa.descripcion }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </ng-template>

                </div>


                <!-- Sección Auditoría -->
                <div *ngIf="seccion === 'auditoria'" class="space-y-6 mt-8">
                    <h2 class="text-2xl font-bold text-[#004C77]">Historial de Auditoría</h2>

                    <div *ngIf="auditorias.length === 0" class="text-gray-500 italic">
                        No hay registros de auditoría disponibles para este expediente.
                    </div>

                    <div *ngFor="let entry of auditorias"
                        class="border border-gray-300 bg-white shadow-sm rounded-lg p-6 space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">{{ entry.fechaHora | date:'medium' }}</span>
                            <span class="text-sm font-semibold text-white px-3 py-1 rounded-full" [ngClass]="{
              'bg-green-600': entry.accion === 'CREACION',
              'bg-yellow-600': entry.accion === 'EDICION',
              'bg-red-600': entry.accion === 'ELIMINACION'
            }">
                                {{ entry.accion }}
                            </span>
                        </div>

                        <div class="text-sm text-gray-800">
                            <p><strong>Usuario ID:</strong> {{ entry.usuario }}</p>
                            <p *ngIf="entry.descripcion"><strong>Descripción:</strong> {{ entry.descripcion }}</p>
                            <p *ngIf="entry.documentoId"><strong>Documento ID:</strong> {{ entry.documentoId }}</p>
                            <p *ngIf="entry.cargoId"><strong>Cargo ID:</strong> {{ entry.cargoId }}</p>
                        </div>
                    </div>
                </div>

            </ng-container>
        </div>
    </div>
</div>