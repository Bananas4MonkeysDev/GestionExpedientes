<!-- Breadcrumb -->

<!-- Breadcrumb actualizado -->
<!-- CONTENEDOR PESTAÑA 1 -->
<div class="min-h-screen bg-gray-100 p-4 -space-y-8">
  <div *ngIf="isLoading" class="fixed inset-0 z-50 bg-white bg-opacity-75 flex items-center justify-center">
    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-[#004C77] border-solid"></div>
    <span class="ml-4 text-[#004C77] font-semibold text-lg">Enviando cargo...</span>
  </div>
  <div *ngIf="!isLoading">

    <div class="text-sm text-gray-600 mb-2">
      <span class="text-[#004C77] font-semibold">Inicio</span> &gt;
      <span class="text-[#004C77] font-semibold">Expedientes</span> &gt;
      <span [ngClass]="{
  'text-[#F36C21]': !tipoExpediente,
  'text-[#004C77]': tipoExpediente
}" class="font-semibold">
        Adicionar expediente
      </span>
      <ng-container *ngIf="tipoExpediente">
        &gt; <span class="text-[#F36C21] font-semibold capitalize">{{ tipoExpediente }}</span>
      </ng-container>
    </div>

    <!-- Título actualizado -->
    <div class="flex justify-between items-center mb-2">

      <h1 class="text-2xl font-bold text-[#004C77] mb-4">
        Adicionar Expediente
        <span *ngIf="tipoExpediente"> - {{ tipoExpediente | titlecase }}</span>
      </h1>
      <button *ngIf="pasoActual === 4" (click)="irARegistroExpediente()" matTooltip="Registrar nuevo expediente"
        class="cursor-pointer flex items-center gap-2 px-4 py-1 text-sm rounded-md bg-[#004C77] text-white hover:bg-[#F36C21] transition-all">
        <mat-icon class="!text-white">add</mat-icon>
        Nuevo Expediente
      </button>
    </div>


    <!-- Barra de pasos -->
    <div class="flex items-center gap-2 mb-6">
      <div *ngFor="let paso of [1, 2, 3, 4]" class="flex-1 h-2 rounded-full"
        [ngClass]="{ 'bg-[#004C77]': pasoActual >= paso, 'bg-gray-300': pasoActual < paso }">
      </div>
    </div>


    <!-- PASO 1 -->
    <div *ngIf="pasoActual === 1" class="bg-white rounded-xl shadow p-8 space-y-6">
      <h2 class="text-xl font-semibold text-[#004C77]">Seleccionar tipo de expediente</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <button (click)="seleccionarTipo('Emisor')"
          class="cursor-pointer w-full py-1.5 bg-[#004C77] text-white font-semibold rounded hover:opacity-90 transition">Expediente
          Emisor</button>
        <button (click)="seleccionarTipo('Receptor')"
          class="cursor-pointer w-full py-1.5 bg-[#F36C21] text-white font-semibold rounded hover:opacity-90 transition">Expediente
          Receptor</button>
      </div>
    </div>

    <!-- PASO 2 -->
    <div *ngIf="pasoActual === 2" class="bg-white rounded-xl shadow p-8 space-y-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-[#004C77]">Registrar información del expediente</h2>

        <button type="button" matTooltip="Escanea y extrae automáticamente informacion clave" matTooltipPosition="above"
          (click)="scanCarta()"
          class="flex items-center gap-2 px-4 py-1.5 rounded-full bg-[#004C77] text-white hover:bg-[#003354] transition cursor-pointer"
          title="Escanear documento">
          <mat-icon fontIcon="scanner" class="!text-white">scanner</mat-icon>
          <span class="text-sm font-light">Escanear datos</span>
        </button>
      </div>

      <form [formGroup]="formularioPaso1" (ngSubmit)="siguientePaso()"
        class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
        <div class="md:col-span-2">
          <!-- USUARIO EMISOR -->
          <div class="md:col-span-2">
            <label class="text-sm font-medium text-gray-700 label-obligatorio">Usuario emisor</label>

            <div
              class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
              <ng-container *ngIf="controlUsuario.value?.length; else placeholderEmisor">
                <div *ngFor="let user of controlUsuario.value"
                  class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                  {{ user }}
                  <button type="button" (click)="removerUsuario(user)" class="ml-2 hover:text-red-600 cursor-pointer">
                    <mat-icon class="text-xs">cancel</mat-icon>
                  </button>
                </div>
              </ng-container>
              <ng-template #placeholderEmisor>
                <span class="text-sm text-gray-400">Ningún usuario seleccionado</span>
              </ng-template>
            </div>

            <div class="flex gap-2 items-start">
              <mat-form-field appearance="outline" class="w-full"
                matTooltip="Ingresa el/los remitente(s) del expediente">
                <mat-select [formControl]="controlUsuario" multiple class="max-w-full"
                  (closed)="reiniciarFiltroTipoTo()">
                  <mat-option class="!cursor-default" disabled>
                    <ngx-mat-select-search [formControl]="searchCtrlUsuario" placeholderLabel="Buscar referencia..."
                      (keydown.enter)="abrirDialogoAgregarUsuario(searchCtrlUsuario.value || '', 'to')"
                      noEntriesFoundLabel="No encontrado. Presiona ENTER para registrar nueva referencia">
                    </ngx-mat-select-search>
                  </mat-option>

                  <div class="flex items-center gap-2 py-2 px-3 rounded-md bg-gray-50">
                    <label class="text-xs text-gray-600 whitespace-nowrap">Filtrar por segmento:</label>
                    <select [(ngModel)]="filtroTipoUsuarioTo" [ngModelOptions]="{ standalone: true }"
                      (ngModelChange)="filtrarUsuariosTo()"
                      class="text-sm border border-gray-300 rounded px-2 py-1 bg-white focus-within:border-[#004C77] shadow-sm cursor-pointer">
                      <option value="">Todos</option>
                      <option *ngFor="let tipo of tiposUsuario" [value]="tipo">{{ tipo }}</option>
                    </select>
                  </div>

                  <mat-optgroup *ngFor="let tipo of tiposUsuario" [label]="tipo" [hidden]="!mostrarGrupo(tipo)">
                    <mat-option *ngFor="let user of obtenerUsuariosPorTipo(usuariosFiltradosTo, tipo)"
                      [value]="user.nombre">
                      {{ user.nombre }} - {{ user.correo }}
                    </mat-option>
                  </mat-optgroup>
                </mat-select>
              </mat-form-field>

              <button type="button" #btnAgregarUsuario (click)="desenfocarYabrir(btnAgregarUsuario, '', 'to')"
                class="cursor-pointer h-[56px] min-h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition-colors duration-200"
                matTooltip="Agregar nuevo usuario">
                <mat-icon fontIcon="person_add" class="text-base">person_add</mat-icon>
              </button>
            </div>
          </div>

          <!-- USUARIO DESTINATARIO (CC) -->
          <div class="md:col-span-2">
            <label class="text-sm font-medium text-gray-700 label-obligatorio">Usuario destinatario (CC)</label>

            <div
              class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
              <ng-container *ngIf="controlUsuarioCc.value?.length; else placeholderCc">
                <div *ngFor="let user of controlUsuarioCc.value"
                  class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                  {{ user }}
                  <button type="button" (click)="removerUsuarioCc(user)" class="ml-2 hover:text-red-600 cursor-pointer">
                    <mat-icon class="text-xs">cancel</mat-icon>
                  </button>
                </div>
              </ng-container>
              <ng-template #placeholderCc>
                <span class="text-sm text-gray-400">Ningún usuario seleccionado</span>
              </ng-template>
            </div>

            <div class="flex gap-2 items-start">
              <mat-form-field appearance="outline" class="w-full" matTooltip="Ingresa el/los destinatario(s) en copia">
                <mat-select [formControl]="controlUsuarioCc" multiple class="max-w-full"
                  (closed)="reiniciarFiltroTipoCc()">
                  <mat-option class="!cursor-default" disabled>
                    <ngx-mat-select-search [formControl]="searchCtrlCc" placeholderLabel="Buscar referencia..."
                      (keydown.enter)="abrirDialogoAgregarUsuario(searchCtrlCc.value || '', 'cc')"
                      noEntriesFoundLabel="No encontrado. Presiona ENTER para registrar nueva referencia">
                    </ngx-mat-select-search>
                  </mat-option>

                  <div class="flex items-center gap-2 py-2 px-3 rounded-md bg-gray-50">
                    <label class="text-xs text-gray-600 whitespace-nowrap">Filtrar por segmento:</label>
                    <select [(ngModel)]="filtroTipoUsuarioCc" [ngModelOptions]="{ standalone: true }"
                      (ngModelChange)="filtrarUsuariosCc()"
                      class="text-sm border border-gray-300 rounded px-2 py-1 bg-white focus-within:border-[#004C77] shadow-sm cursor-pointer">
                      <option value="">Todos</option>
                      <option *ngFor="let tipo of tiposUsuario" [value]="tipo">{{ tipo }}</option>
                    </select>
                  </div>

                  <mat-optgroup *ngFor="let tipo of tiposUsuario" [label]="tipo" [hidden]="!mostrarGrupo(tipo)">
                    <mat-option *ngFor="let user of obtenerUsuariosPorTipo(usuariosFiltradosCc, tipo)"
                      [value]="user.nombre">
                      {{ user.nombre }} - {{ user.correo }}
                    </mat-option>
                  </mat-optgroup>
                </mat-select>
              </mat-form-field>

              <button type="button" #btnAgregarUsuarioCC (click)="desenfocarYabrir(btnAgregarUsuarioCC, '', 'cc')"
                class="cursor-pointer h-[56px] min-h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition-colors duration-200"
                matTooltip="Agregar nuevo usuario">
                <mat-icon fontIcon="person_add" class="text-base">person_add</mat-icon>
              </button>
            </div>
          </div>
        </div>
        <!-- REFERENCIA(S) -->
        <div class="md:col-span-2">
          <label class="text-sm font-medium text-gray-700 label-obligatorio">Referencia(s)</label>

          <!-- Chips seleccionados -->
          <div
            class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
            <ng-container *ngIf="controlReferencia.value?.length; else placeholderReferencia">
              <div *ngFor="let ref of controlReferencia.value"
                class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                {{ ref.serie }}
                <button type="button" (click)="removerReferencia(ref)"
                  class="ml-2 text-[#004C77] hover:text-red-600 cursor-pointer">
                  <mat-icon class="text-xs">cancel</mat-icon>
                </button>
              </div>
            </ng-container>
            <ng-template #placeholderReferencia>
              <span class="text-sm text-gray-400">Ninguna referencia seleccionada</span>
            </ng-template>
          </div>

          <!-- Select + botón -->
          <div class="flex gap-2 items-start">
            <mat-form-field appearance="outline" class="w-full"
              matTooltip="Relaciona el expediente con una carta, documento o expediente anterior">
              <mat-select [formControl]="controlReferencia" [compareWith]="compararReferencias" multiple
                class="max-w-full" (closed)="reiniciarFiltroTipoReferencia()">

                <!-- Buscador y entrada manual -->
                <mat-option class="!cursor-default" disabled>
                  <ngx-mat-select-search [formControl]="searchCtrlReferencia"
                    placeholderLabel="Buscar o escribir referencia libre"
                    noEntriesFoundLabel="No hay referencias coincidentes, presiona el botón para añadir manualmente ->">
                  </ngx-mat-select-search>
                </mat-option>

                <!-- Filtro -->
                <div class="flex items-center gap-2 py-2 px-3 rounded-md bg-gray-50">
                  <label class="text-xs text-gray-600 whitespace-nowrap">Filtrar por tipo:</label>
                  <select [(ngModel)]="filtroTipoReferencia" [ngModelOptions]="{ standalone: true }"
                    class="cursor-pointer text-sm border border-gray-300 rounded px-2 py-1 bg-white focus:border-[#004C77] transition-colors duration-200 shadow-sm"
                    (ngModelChange)="filtrarReferencias()">
                    <option value="">Todos</option>
                    <option *ngFor="let tipo of tiposReferencia" [value]="tipo">{{ tipo }}</option>
                  </select>
                </div>

                <!-- Referencias por tipo -->
                <mat-optgroup *ngFor="let tipo of tiposReferencia" [label]="tipo">
                  <mat-option *ngFor="let ref of obtenerReferenciasPorTipo(tipo)" [value]="ref">
                    {{ ref.serie }} - {{ ref.asunto }}
                  </mat-option>
                </mat-optgroup>

                <!-- Manuales -->
                <mat-optgroup label="Ingreso Manual" *ngIf="referenciasLibresSeleccionadas().length > 0">
                  <mat-option *ngFor="let ref of referenciasLibresSeleccionadas()" [value]="ref">
                    {{ ref.serie }} - {{ ref.asunto }}
                  </mat-option>
                </mat-optgroup>
              </mat-select>
            </mat-form-field>

            <!-- Botón agregar -->
            <button type="button" (click)="abrirDialogoAgregarReferencia()"
              class="cursor-pointer h-[56px] min-h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition-colors duration-200"
              matTooltip="Agregar referencia manualmente">
              <mat-icon fontIcon="note_add" class="text-base">note_add</mat-icon>
            </button>
          </div>
        </div>
        <!-- Asunto -->
        <div class="mb-4">
          <label class="text-sm font-medium text-gray-700 label-obligatorio">Asunto</label>
          <input matTooltip="Resumen del contenido del expediente" type="text" formControlName="asunto"
            class="w-full px-3 py-2 border border-gray-500 rounded bg-white focus:ring-2 focus:ring-[#005CBB] focus:outline-none transition duration-200" />
        </div>

        <!-- Fecha -->
        <div class="mb-4">
          <label class="text-sm font-medium text-gray-700 label-obligatorio">Fecha</label>
          <input type="date" formControlName="fecha"
            class="cursor-pointer w-full px-3 py-2 border border-gray-500 rounded bg-white focus:ring-2 focus:ring-[#005CBB] focus:outline-none transition duration-200" />
        </div>

        <!-- Proyecto -->
        <div class="w-full md:col-span-2">
          <label class="text-sm font-medium text-gray-700 label-obligatorio">Proyecto</label>
          <div class="flex items-center gap-2">
            <!-- Select con altura consistente -->
            <select formControlName="proyecto"
              class="cursor-pointer flex-1 h-[56px] px-3 border border-gray-500 rounded bg-white text-gray-700 focus:ring-2 focus:ring-[#005CBB] focus:outline-none transition duration-200"
              required>
              <option value="" disabled selected>Seleccione</option>
              <option *ngFor="let proyecto of proyectos" [value]="proyecto.id">{{ proyecto.nombre }}</option>
            </select>

            <!-- Botón al mismo nivel -->
            <button type="button" (click)="abrirDialogoProyecto()"
              class="cursor-pointer h-[56px] w-[56px] flex items-center justify-center bg-[#004C77] text-white rounded hover:bg-[#003655] transition-colors duration-200"
              matTooltip="Agregar nuevo proyecto">
              <mat-icon fontIcon="library_add" class="text-white text-base">library_add</mat-icon>
            </button>
          </div>
        </div>

        <!-- Reservado -->
        <div class="md:col-span-2">
          <label class="text-sm font-medium text-gray-700 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-[#F36C21]" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 11c0 1.104-.896 2-2 2s-2-.896-2-2 .896-2 2-2 2 .896 2 2z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4z" />
            </svg>
            Reservado
          </label>
          <div class="flex gap-6 mt-2 mb-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" formControlName="reservado" value="si" class="cursor-pointer accent-[#004C77]" />
              <span class="text-sm">Sí</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" formControlName="reservado" value="no" class="cursor-pointer accent-[#004C77]" />
              <span class="text-sm">No</span>
            </label>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="md:col-span-2">
          <label class="text-sm font-medium text-gray-700">Observaciones</label>
          <textarea formControlName="comentario" rows="3" class="w-full px-3 py-2 border border-gray-500 rounded resize-none bg-white 
           focus:ring-2 focus:ring-[#005CBB] focus:outline-none transition duration-200">
          </textarea>
        </div>


        <div class="md:col-span-2 flex justify-between items-center mt-4">
          <button type="button" (click)="regresarPaso()"
            class="text-[#004C77] font-medium hover:underline cursor-pointer">←
            Regresar</button>
          <button type="submit" [disabled]="formularioPaso1.invalid"
            class="bg-[#004C77] text-white px-6 py-2 rounded hover:opacity-90 disabled:bg-gray-300 cursor-pointer">Siguiente</button>
        </div>
      </form>
    </div>
    <!-- PASO 3 para tipo Emisor -->
    <div *ngIf="pasoActual === 3 && tipoExpediente === 'Emisor'" class="bg-white rounded-xl shadow p-8 space-y-6">
      <!-- Selector de tipo de flujo de firma mejorado -->
      <div class="bg-white border border-gray-300 shadow-sm rounded-xl px-6 py-5 mb-6">
        <h2 class="text-xl font-semibold text-[#004C77]">Tipo de flujo de firma:</h2>

        <div class="flex gap-2 bg-gray-100 rounded-full w-fit p-1 shadow-inner">
          <!-- Botón: Por documento -->
          <button type="button" (click)="modoFlujoFirma = 'individual'" [ngClass]="{
        'bg-white shadow text-[#004C77] font-semibold': modoFlujoFirma === 'individual',
        'text-gray-600 hover:text-[#004C77]': modoFlujoFirma !== 'individual'
      }" class="cursor-pointer px-4 py-1.5 text-sm rounded-full transition-all duration-200">
            Niveles por documento
          </button>

          <!-- Botón: General -->
          <button type="button" (click)="modoFlujoFirma = 'general'" [ngClass]="{
        'bg-white shadow text-[#004C77] font-semibold': modoFlujoFirma === 'general',
        'text-gray-600 hover:text-[#004C77]': modoFlujoFirma !== 'general'
      }" class="cursor-pointer px-4 py-1.5 text-sm rounded-full transition-all duration-200">
            Niveles generales
          </button>
        </div>
      </div>
      <!-- Línea divisora -->
      <hr class="mt-6 border-t border-gray-300">
      <h2 class="text-xl font-semibold text-[#004C77]">Documentos heredados del expediente base</h2>
      <div *ngIf="documentosExistentes.length === 0" class="text-sm text-gray-500 italic mb-4">
        No se han heredado documentos del expediente base.
      </div>
      <!-- Documentos existentes -->
      <div *ngFor="let doc of documentosExistentes; let i = index"
        class="space-y-4 items-center bg-white border border-gray-200 shadow-sm rounded px-4 py-3">
        <div class="flex flex-col md:flex-row justify-between gap-4 items-start md:items-center">
          <div class="flex items-center gap-3 w-full">
            <svg class="w-5 h-5 text-[#004C77] flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M7 7h10M7 11h10M7 15h10M5 5v14a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2 2H7a2 2 0 00-2 2z" />
            </svg>
            <span class="text-sm text-gray-700 w-[200px] truncate">
              {{ doc.nombreArchivo }}
            </span>
            <span class="text-xs text-gray-500">{{ formatearPeso(doc['tamaño']) }}</span>
          </div>
          <!-- Tipo solo lectura -->
          <div class="w-[180px]">
            <label class="text-xs text-gray-500 block mb-1">Tipo de documento</label>
            <input type="text" class="w-full px-2 py-1 text-sm border border-gray-300 rounded bg-gray-100"
              [value]="doc.tipoDocumento" readonly />
          </div>
          <!-- Requiere firma -->
          <div class="flex flex-col items-center gap-1 min-w-[100px] whitespace-nowrap">
            <label class="text-xs text-gray-500">¿Requiere firma?</label>
            <input type="checkbox" [(ngModel)]="doc.requiereFirma" (ngModelChange)="actualizarEstadoBotonRegistro()"
              class="accent-[#004C77] w-4 h-4 cursor-pointer">
          </div>

          <!-- Botón Ver -->
          <div class="flex gap-3 text-sm">
            <button (click)="abrirEnNuevaVentana(transformarRutaDocumento(doc.rutaArchivo)!)" matTooltip="Ver documento"
              class="text-[#004C77] hover:underline cursor-pointer">Ver</button>
          </div>
        </div>
        <div *ngIf="modoFlujoFirma === 'individual'&& doc.requiereFirma">
          <div class="items-center bg-white border border-gray-200 shadow-sm rounded px-4 py-3">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Flujo de firma para {{ doc.nombreArchivo }} </h3>
            <div *ngFor="let nivel of doc.nivelesFirma; let j = index" class="mb-3">
              <!-- Fecha límite de firma -->
              <div class="mb-3">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-medium text-[#004C77]">Nivel {{ j + 1 }}</span>
                  <button type="button" (click)="eliminarNivel(doc, j)" matTooltip="Eliminar Nivel"
                    class="cursor-pointer text-red-600 text-xs hover:underline">
                    Eliminar nivel
                  </button>
                </div>
                <div class="mt-4 pb-4 w-full">
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Fecha límite de firma
                  </label>
                  <div class="relative">
                    <input type="date" [(ngModel)]="nivel.fechaLimite"
                      [min]="doc.nivelesFirma[j - 1]?.fechaLimite || minDateString"
                      (ngModelChange)="validarFechasEnCascada(doc.nivelesFirma)" class="w-full ..."
                      placeholder="dd/mm/aaaa" />

                  </div>
                </div>
                <!-- Chips de usuarios seleccionados -->
                <div
                  class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
                  <ng-container *ngIf="nivel.controlUsuarios.value?.length; else placeholderNivel">
                    <div *ngFor="let user of nivel.controlUsuarios.value"
                      class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                      {{ user }}
                      <button type="button" (click)="removerUsuarioNivel(user, nivel)"
                        class="ml-2 hover:text-red-600 cursor-pointer">
                        <mat-icon class="text-xs">cancel</mat-icon>
                      </button>
                    </div>
                  </ng-container>
                  <ng-template #placeholderNivel>
                    <span class="text-sm text-gray-400">Ningún usuario seleccionado</span>
                  </ng-template>
                </div>
                <!-- Selector -->
                <div class="flex gap-2 items-start">
                  <mat-form-field appearance="outline" class="w-full"
                    matTooltip="Selecciona usuarios internos para este nivel">
                    <mat-select [formControl]="nivel.controlUsuarios" multiple class="max-w-full"
                      (closed)="reiniciarFiltroInternos(nivel)">
                      <mat-option class="!cursor-default" disabled>
                        <ngx-mat-select-search [formControl]="nivel.searchControl" placeholderLabel="Buscar usuario..."
                          (keydown.enter)="abrirDialogoAgregarUsuario(nivel.searchControl.value || '', 'nivel')"
                          noEntriesFoundLabel="No encontrado. Presiona ENTER para registrar nuevo usuario interno">
                        </ngx-mat-select-search>
                      </mat-option>

                      <mat-optgroup *ngFor="let tipo of tiposUsuarioFirma" [label]="tipo"
                        [hidden]="!mostrarGrupoInternoTipo(tipo, nivel)">
                        <mat-option *ngFor="let user of obtenerUsuariosPorTipoFirma(nivel.usuariosFiltrados, tipo)"
                          [value]="user.nombre">
                          {{ user.nombre }} - {{ user.correo }}
                        </mat-option>
                      </mat-optgroup>
                    </mat-select>

                  </mat-form-field>

                  <button type="button" #btnAgregarUsuarioNivel
                    (click)="desenfocarYabrir(btnAgregarUsuarioNivel, '', 'nivel')"
                    class="cursor-pointer h-[56px] min-h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition-colors duration-200"
                    matTooltip="Agregar nuevo usuario interno">
                    <mat-icon fontIcon="person_add" class="text-base">person_add</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <button type="button" [disabled]="!doc.requiereFirma" matTooltip="Agregar Nivel" (click)="agregarNivel(doc)"
            class="cursor-pointer text-sm text-[#004C77] hover:underline px-4">
            + Agregar nivel para {{ doc.nombreArchivo }}
          </button>
        </div>
      </div>
      <!-- NIVELES GENERALES DE FIRMA (si está seleccionado el modo general) -->


      <!-- Divider -->
      <hr class="my-6 border-gray-300" />
      <!-- NUEVOS DOCUMENTOS (solo para tipo Emisor) -->
      <div class="space-y-6">
        <h2 class="text-xl font-semibold text-[#004C77]">Carga de nuevos documentos del expediente</h2>

        <!-- Drag & Drop -->
        <div class="border-2 border-dashed rounded-lg p-10 text-center transition-all duration-300" [ngClass]="{
    'border-[#004C77] bg-blue-50': arrastrando,
    'border-gray-300 bg-gray-50': !arrastrando
  }" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onFileDrop($event)">
          <label for="uploadInputEmisor" class="cursor-pointer flex flex-col items-center space-y-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-[#004C77]" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M16 12l-4-4m0 0l-4 4m4-4v12" />
            </svg>
            <span class="text-sm text-gray-600">Arrastra tus archivos aquí o haz clic para seleccionar</span>
            <span class="text-xs text-gray-400">Archivos permitidos: PDF</span>
          </label>
          <input id="uploadInputEmisor" type="file" accept=".pdf" multiple class="hidden"
            (change)="onMultipleFilesSelectedx($event)" />
        </div>

        <!-- Lista de nuevos documentos -->
        <div *ngIf="documentosNuevos.length > 0" class="space-y-4">
          <h4 class="text-sm font-semibold text-gray-700">Documentos añadidos</h4>

          <div *ngFor="let doc of documentosNuevos; let i = index"
            class="bg-white border border-gray-200 shadow-sm rounded px-4 py-3 space-y-4">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
              <!-- Nombre y progreso -->
              <div class="flex items-center gap-3 w-full">
                <svg class="w-5 h-5 text-[#004C77] flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M7 7h10M7 11h10M7 15h10M5 5v14a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2z" />
                </svg>
                <span class="text-sm text-gray-700 w-[200px] truncate">
                  {{ doc.nombre }}
                </span>
                <div class="flex-1 flex items-center gap-2">
                  <span class="text-xs text-gray-500 min-w-[55px] text-right">
                    {{ formatearPeso(doc.archivo.size) }}
                  </span>
                  <div class="w-full max-w-[150px] h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-full bg-[#004C77] transition-all duration-300" [style.width.%]="doc.progreso"></div>
                  </div>
                  <svg *ngIf="doc.cargado" class="w-5 h-5 text-green-600" fill="none" stroke="currentColor"
                    stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                </div>
              </div>

              <!-- Tipo -->
              <div class="w-[180px]">
                <label class="text-xs text-gray-500 block mb-1">Tipo de documento</label>
                <select [(ngModel)]="doc.tipoDocumento" [ngModelOptions]="{ standalone: true }"
                  class="cursor-pointer w-full px-2 py-1 text-sm border border-gray-300 rounded" required>
                  <option value="" disabled>Seleccione</option>
                  <option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{ tipo }}</option>
                </select>
              </div>

              <!-- Visibilidad + Acciones -->
              <div class="flex gap-3 text-sm">
                <button [matTooltip]="doc.visibleParaExternos ? 'Visible para externos' : 'Oculto para externos'"
                  (click)="alternarVisibilidadNuevo(i)" class="cursor-pointer p-1 rounded hover:bg-gray-100 transition">
                  <svg *ngIf="doc.visibleParaExternos" class="w-5 h-5 text-[#F36C21]" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7s-8.268-2.943-9.542-7z" />
                  </svg>
                  <svg *ngIf="!doc.visibleParaExternos" class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.969 9.969 0 012.386-3.872M10.6 4.184a9.957 9.957 0 012.268-.184c4.477 0 8.268 2.943 9.542 7a9.97 9.97 0 01-4.293 5.187M3 3l18 18" />
                  </svg>
                </button>

                <button (click)="verDocumentoNuevo(i)" matTooltip="Visualizar Documento"
                  class="text-[#004C77] hover:underline cursor-pointer">Ver</button>
                <button (click)="eliminarDocumentoNuevo(i)" matTooltip="Eliminar Documento"
                  class="text-red-600 hover:underline cursor-pointer">Eliminar</button>
              </div>
            </div>
            <!-- BLOQUE DE FLUJO DE FIRMA PARA DOCUMENTOS NUEVOS -->
            <div *ngIf="modoFlujoFirma === 'individual'" class="mt-4 w-full pt-4">
              <h3 class="text-sm font-semibold text-gray-700 mb-2">Flujo de firma para {{ doc.nombre }}</h3>

              <div *ngFor="let nivel of doc.nivelesFirma; let j = index" class="mb-4 rounded p-3 bg-gray-50">
                <!-- Cabecera -->
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium text-[#004C77]">Nivel {{ j + 1 }}</span>
                  <button type="button" (click)="eliminarNivel(doc, j)" matTooltip="Eliminar Nivel"
                    class="cursor-pointer text-red-600 text-xs hover:underline">
                    Eliminar nivel
                  </button>
                </div>

                <!-- Fecha límite -->
                <div class="mb-3">
                  <label class="block text-sm text-gray-700 mb-1">Fecha límite</label>
                  <input type="date" [(ngModel)]="nivel.fechaLimite"
                    [min]="doc.nivelesFirma[j - 1]?.fechaLimite || minDateString"
                    (ngModelChange)="validarFechasEnCascada(doc.nivelesFirma)"
                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm" />
                </div>

                <!-- Chips de usuarios -->
                <div
                  class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
                  <ng-container *ngIf="nivel.controlUsuarios.value?.length; else placeholderNivelNuevo">
                    <div *ngFor="let user of nivel.controlUsuarios.value"
                      class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                      {{ user }}
                      <button type="button" (click)="removerUsuarioNivel(user, nivel)"
                        class="ml-2 hover:text-red-600 cursor-pointer">
                        <mat-icon class="text-xs">cancel</mat-icon>
                      </button>
                    </div>
                  </ng-container>
                  <ng-template #placeholderNivelNuevo>
                    <span class="text-sm text-gray-400">Ningún usuario seleccionado</span>
                  </ng-template>
                </div>

                <!-- Selector -->
                <div class="flex gap-2 items-start">
                  <mat-form-field appearance="outline" class="w-full" matTooltip="Selecciona usuarios internos">
                    <mat-select [formControl]="nivel.controlUsuarios" multiple class="max-w-full"
                      (closed)="reiniciarFiltroInternos(nivel)">
                      <mat-option class="!cursor-default" disabled>
                        <ngx-mat-select-search [formControl]="nivel.searchControl" placeholderLabel="Buscar usuario..."
                          (keydown.enter)="abrirDialogoAgregarUsuario(nivel.searchControl.value || '', 'nivel')"
                          noEntriesFoundLabel="No encontrado. Presiona ENTER para registrar nuevo usuario interno">
                        </ngx-mat-select-search>
                      </mat-option>

                      <!-- Usuarios agrupados -->
                      <mat-optgroup *ngFor="let tipo of tiposUsuarioFirma" [label]="tipo"
                        [hidden]="!mostrarGrupoInternoTipo(tipo, nivel)">
                        <mat-option *ngFor="let user of obtenerUsuariosPorTipoFirma(nivel.usuariosFiltrados, tipo)"
                          [value]="user.nombre">
                          {{ user.nombre }} - {{ user.correo }}
                        </mat-option>
                      </mat-optgroup>
                    </mat-select>
                  </mat-form-field>

                  <!-- Botón Agregar Usuario -->
                  <button type="button" #btnAgregarUsuarioNuevo
                    (click)="desenfocarYabrir(btnAgregarUsuarioNuevo, '', 'nivel')"
                    class="cursor-pointer h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition"
                    matTooltip="Agregar nuevo usuario interno">
                    <mat-icon fontIcon="person_add" class="text-base">person_add</mat-icon>
                  </button>
                </div>
              </div>

              <button type="button" matTooltip="Agregar Nivel" (click)="agregarNivel(doc)"
                class="cursor-pointer text-sm text-[#004C77] hover:underline mt-2">
                + Agregar nivel para {{ doc.nombre }}
              </button>
            </div>
          </div>
        </div>
      </div>
      <hr class="my-6 border-gray-300" />
      <div *ngIf="modoFlujoFirma === 'general'"
        class="mt-6 items-center bg-white border border-gray-200 shadow-sm rounded px-4 py-3">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">Flujo de firma general para todos los documentos</h3>

        <div *ngFor="let nivel of nivelesFirmaGenerales; let j = index" class="mb-3">
          <div class="mb-3">
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm font-medium text-[#004C77]">Nivel {{ j + 1 }}</span>
              <button type="button" (click)="eliminarNivelGeneral(j)" matTooltip="Eliminar Nivel"
                class="cursor-pointer text-red-600 text-xs hover:underline">
                Eliminar nivel
              </button>
            </div>
            <div class="mt-4 pb-4 w-full">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Fecha límite de firma
              </label>

              <div class="relative">
                <input type="date" [(ngModel)]="nivel.fechaLimite"
                  [min]="nivelesFirmaGenerales[j - 1]?.fechaLimite || minDateString"
                  (ngModelChange)="validarFechasEnCascada(nivelesFirmaGenerales)" class="w-full ..."
                  placeholder="dd/mm/aaaa" />

              </div>
            </div>
            <!-- Chips de usuarios seleccionados -->
            <div
              class="flex flex-wrap gap-2 mb-2 min-h-[56px] border border-gray-300 rounded px-3 py-1.5 bg-white items-center">
              <ng-container *ngIf="nivel.controlUsuarios.value?.length; else placeholderNivelGeneral">
                <div *ngFor="let user of nivel.controlUsuarios.value"
                  class="flex items-center bg-[#E6F2F8] text-[#004C77] text-sm px-3 py-1 rounded-full">
                  {{ user }}
                  <button type="button" (click)="removerUsuarioNivelGeneral(user, nivel)"
                    class="ml-2 hover:text-red-600 cursor-pointer">
                    <mat-icon class="text-xs">cancel</mat-icon>
                  </button>
                </div>
              </ng-container>
              <ng-template #placeholderNivelGeneral>
                <span class="text-sm text-gray-400">Ningún usuario seleccionado</span>
              </ng-template>
            </div>

            <!-- Selector -->
            <div class="flex gap-2 items-start">
              <mat-form-field appearance="outline" class="w-full"
                matTooltip="Selecciona usuarios internos para este nivel">
                <mat-select [formControl]="nivel.controlUsuarios" multiple class="max-w-full"
                  (closed)="reiniciarFiltroInternos(nivel)">
                  <mat-option class="!cursor-default" disabled>
                    <ngx-mat-select-search [formControl]="nivel.searchControl" placeholderLabel="Buscar usuario..."
                      (keydown.enter)="abrirDialogoAgregarUsuario(nivel.searchControl.value || '', 'nivel')"
                      noEntriesFoundLabel="No encontrado. Presiona ENTER para registrar nuevo usuario interno">
                    </ngx-mat-select-search>
                  </mat-option>
                  <mat-optgroup *ngFor="let tipo of tiposUsuarioFirma" [label]="tipo"
                    [hidden]="!mostrarGrupoInternoTipo(tipo, nivel)">
                    <mat-option *ngFor="let user of obtenerUsuariosPorTipoFirma(nivel.usuariosFiltrados, tipo)"
                      [value]="user.nombre">
                      {{ user.nombre }} - {{ user.correo }}
                    </mat-option>
                  </mat-optgroup>
                </mat-select>
              </mat-form-field>

              <button type="button" #btnAgregarUsuarioNivel
                (click)="desenfocarYabrir(btnAgregarUsuarioNivel, '', 'nivel')"
                class="cursor-pointer h-[56px] min-h-[56px] px-3 py-2 bg-[#004C77] text-white rounded-md hover:bg-[#003655] transition-colors duration-200"
                matTooltip="Agregar nuevo usuario interno">
                <mat-icon fontIcon="person_add" class="text-base">person_add</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <button type="button" matTooltip="Agregar Nivel" (click)="agregarNivelGeneral()"
          class="cursor-pointer text-sm text-[#004C77] hover:underline mt-2">
          + Agregar nivel general
        </button>
      </div>
      <hr class="my-6 border-gray-300" />

      <!-- Botones -->
      <div class="flex justify-between items-center mt-6">
        <button type="button" (click)="regresarPaso()"
          class="text-[#004C77] font-medium hover:underline cursor-pointer">←
          Regresar</button>
        <button [disabled]="!validarNivelesFirma()" (click)="onSubmit()"
          class="cursor-pointer bg-[#004C77] text-white px-4 py-2 rounded disabled:bg-gray-300 disabled:cursor-not-allowed transition">
          Registrar expediente
        </button>
      </div>
    </div>
    <!-- PASO 3 -->
    <div *ngIf="pasoActual === 3 && tipoExpediente !== 'Emisor'" class="bg-white rounded-xl shadow p-8 space-y-6">
      <h2 class="text-xl font-semibold text-[#004C77]">Carga de documentos del expediente</h2>

      <!-- Drag & Drop -->
      <div class="border-2 border-dashed rounded-lg p-10 text-center transition-all duration-300" [ngClass]="{
    'border-[#004C77] bg-blue-50': arrastrando,
    'border-gray-300 bg-gray-50': !arrastrando
  }" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onFileDrop($event)"
        [ngClass]="{ 'border-blue-500 bg-blue-50': arrastrando }">
        <label for="uploadInput" class="cursor-pointer flex flex-col items-center space-y-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-[#004C77]" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M16 12l-4-4m0 0l-4 4m4-4v12" />
          </svg>
          <span class="text-sm text-gray-600">Arrastra tus archivos aquí o haz clic para seleccionar</span>
          <span class="text-xs text-gray-400">Archivos permitidos: PDF</span>
        </label>
        <input id="uploadInput" type="file" accept=".pdf" multiple class="hidden"
          (change)="onMultipleFilesSelected($event)" />
      </div>


      <!-- Documentos añadidos -->
      <div class="space-y-2">
        <h4 class="text-sm font-semibold text-gray-700">Documentos añadidos</h4>
        <div *ngFor="let doc of documentos; let i = index"
          class="flex justify-between items-center bg-white border border-gray-200 shadow-sm rounded px-4 py-3">
          <div class="flex items-center gap-4 w-full justify-between">
            <!-- Nombre y progreso -->
            <div class="flex items-center gap-3 w-full">
              <svg class="w-5 h-5 text-[#004C77] flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M7 7h10M7 11h10M7 15h10M5 5v14a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2z" />
              </svg>

              <span class="text-sm text-gray-700 w-[200px] truncate">
                {{ doc.nombre }}
              </span>

              <div class="flex-1 flex items-center gap-2">
                <span class="text-xs text-gray-500 min-w-[55px] text-right">
                  {{ formatearPeso(doc.archivo.size) }}
                </span>
                <div class="w-full max-w-[150px] h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full bg-[#004C77] transition-all duration-300" [style.width.%]="doc.progreso"></div>
                </div>
                <svg *ngIf="doc.cargado" class="w-5 h-5 text-green-600" fill="none" stroke="currentColor"
                  stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
              </div>
            </div>

            <!-- Tipo de documento -->
            <div class="w-[180px]">
              <label class="text-xs text-gray-500 block mb-1">Tipo de documento</label>
              <select [(ngModel)]="doc.tipoDocumento" [ngModelOptions]="{ standalone: true }"
                class="cursor-pointer w-full px-2 py-1 text-sm border border-gray-300 rounded" required>
                <option value="" disabled>Seleccione</option>
                <option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{ tipo }}</option>
              </select>
            </div>

            <!-- Acciones -->
            <div class="flex gap-3 text-sm">
              <button [matTooltip]="doc.visibleParaExternos ? 'Visible para externos' : 'Oculto para externos'"
                (click)="alternarVisibilidad(i)" class="cursor-pointer p-1 rounded hover:bg-gray-100 transition">
                <svg *ngIf="doc.visibleParaExternos" class="w-5 h-5 text-[#F36C21]" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7s-8.268-2.943-9.542-7z" />
                </svg>
                <svg *ngIf="!doc.visibleParaExternos" class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.969 9.969 0 012.386-3.872M10.6 4.184a9.957 9.957 0 012.268-.184c4.477 0 8.268 2.943 9.542 7a9.97 9.97 0 01-4.293 5.187M3 3l18 18" />
                </svg>
              </button>
              <button (click)="verDocumento(i)" matTooltip="Visualizar Documento"
                class="text-[#004C77] hover:underline cursor-pointer">Ver</button>
              <button (click)="eliminarDocumento(i)" matTooltip="Eliminar Documento"
                class="text-red-600 hover:underline cursor-pointer">Eliminar</button>
            </div>
          </div>

        </div>
      </div>

      <!-- Botones -->
      <div class="flex justify-between items-center mt-6">
        <button type="button" (click)="regresarPaso()"
          class="text-[#004C77] font-medium hover:underline cursor-pointer">←
          Regresar</button>

        <div class="flex items-center gap-4">
          <button type="button" (click)="omitirCargaDocumentos()"
            class="text-sm text-[#F36C21] hover:underline cursor-pointer">Registrar sin carga de documentos</button>

          <button (click)="onSubmit()" [disabled]="documentos.length === 0 || !todosLosDocumentosTienenTipo()"
            class="bg-[#004C77] text-white px-6 py-2 rounded hover:opacity-90 disabled:bg-gray-300 disabled:cursor-not-allowed cursor-pointer">
            Registrar expediente
          </button>

        </div>
      </div>
    </div>
    <!-- PASO 4: Confirmación y envío de cargo -->
    <div *ngIf="pasoActual === 4" class="bg-white rounded-xl shadow p-8 space-y-6">
      <div class="text-center space-y-4">
        <svg class="w-16 h-16 text-green-500 animate-bounce mx-auto" fill="none" stroke="currentColor" stroke-width="2"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
        <h2 class="text-2xl font-bold text-[#004C77]">¡Expediente registrado con éxito!</h2>

        <p class="text-gray-600 max-w-xl mx-auto">Puede generar y enviar el cargo.</p>
      </div>

      <div class="grid md:grid-cols-2 gap-6 items-start mt-8">
        <!-- Arrastrar documento -->
        <div class="border-2 border-dashed rounded-lg p-6 transition-all text-center"
          [ngClass]="{ 'border-[#004C77] bg-blue-50': arrastrandoCargo, 'border-gray-300 bg-gray-50': !arrastrandoCargo }"
          (dragover)="arrastrandoCargo = true" (dragleave)="arrastrandoCargo = false" (drop)="onFileDropCargo($event)">
          <label for="cargoInput" class="cursor-pointer flex flex-col items-center space-y-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-[#004C77]" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M16 12l-4-4m0 0l-4 4m4-4v12" />
            </svg>
            <span class="text-sm text-gray-600">Cargar documento de cargo (opcional)</span>
            <span class="text-xs text-gray-400">PDF únicamente</span>
          </label>
          <input id="cargoInput" type="file" accept=".pdf" class="hidden" (change)="onCargoSelected($event)" />
          <p class="text-sm mt-2 text-green-600" *ngIf="cargo?.name"> {{ cargo?.name }}</p>
        </div>

        <!-- Formulario lateral -->
        <div class="flex flex-col justify-between">
          <div class="flex items-center gap-4">
            <div class="flex flex-col flex-1">
              <label class="text-sm font-medium text-gray-700">Fecha del cargo <span
                  class="text-red-600">*</span></label>
              <input type="date" [(ngModel)]="fechaCargo" required class="border rounded px-3 py-2" />
            </div>

            <!-- Hora -->
            <div class="flex flex-col flex-1">
              <label class="text-sm font-medium text-gray-700">Hora <span class="text-red-600">*</span></label>
              <input type="time" [(ngModel)]="horaCargo" class="border rounded px-3 py-2" />
            </div>
          </div>

          <div class="mt-6 flex flex-col md:flex-row justify-center gap-2">
            <button (click)="enviarCargo()"
              class="cursor-pointer w-full  bg-[#004C77] text-white px-6 py-2 rounded hover:opacity-90 transition">
              Enviar cargo
            </button>

            <button (click)="confirmarOmitirCargo()"
              class="cursor-pointer w-full  bg-[#F36C21] text-white px-6 py-2 rounded hover:opacity-90 transition">
              Omitir Cargo
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

</div>