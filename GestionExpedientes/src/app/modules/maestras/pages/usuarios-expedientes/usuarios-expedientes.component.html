<div class="bg-gray-100 p-6 space-y-2">
    <!-- Breadcrumb -->
    <div class="text-sm text-gray-600 mb-4">
        <span class="text-[#004C77] font-semibold">Inicio</span> &gt;
        <span class="text-[#004C77] font-semibold">Maestras</span> &gt;
        <span class="text-[#F36C21] font-semibold">Usuarios Expedientes</span>
    </div>

    <!-- Título -->
    <div class="flex justify-between items-center mb-2">
        <h1 class="text-2xl font-bold text-[#004C77]">Gestión de Usuarios de Expedientes</h1>
        <div
            class="px-5 py-1 text-xs uppercase font-semibold text-[#004C77] bg-[#E5EDF3] border border-[#004C77]/40 tracking-wider">
            {{ dataSource.data.length || 0 }} usuarios registrados
        </div>
    </div>
    <hr class="border-t-2 border-[#004C77] rounded-full mb-6" />

    <!-- === BOTONES SUPERIORES === -->
    <!-- === CARD DE ACCIONES === -->
    <div
        class="bg-white border border-gray-200 shadow-md rounded-md p-4 mb-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">

        <!-- IZQUIERDA: Botón de eliminación -->
        <div class="flex items-center gap-2">
            <button matTooltip="Eliminar usuarios seleccionados" [disabled]="selection.selected.length === 0"
                (click)="eliminarSeleccionados()"
                class=" btn-delete flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md transition-all cursor-pointer">
                <mat-icon class="text-base">delete</mat-icon>
                <span>Eliminar seleccionados</span>
            </button>
        </div>

        <!-- DERECHA: Botones de acción -->
        <div class="flex flex-wrap gap-2 justify-end">
            <button (click)="agregarUsuario()" matTooltip="Registrar nuevo usuario"
                class="cursor-pointer btn-action bg-[#004C77] text-white hover:bg-[#003f63]">
                <mat-icon>person_add</mat-icon> Agregar
            </button>

            <button (click)="verHistorialGlobal()" matTooltip="Ver historial global de cambios"
                class="cursor-pointer btn-action bg-[#F36C21] text-white hover:bg-[#e45d13]">
                <mat-icon>history</mat-icon> Historial
            </button>

            <button (click)="exportarExcel()" matTooltip="Exportar tabla a Excel"
                class="cursor-pointer btn-action bg-[#129490] text-white hover:bg-[#0e6c6a]">
                <mat-icon>download</mat-icon> Excel
            </button>

            <button (click)="exportarPDF()" matTooltip="Descargar tabla en PDF"
                class="cursor-pointer btn-action bg-[#e53935] text-white hover:bg-[#c62828]">
                <mat-icon>picture_as_pdf</mat-icon> PDF
            </button>
        </div>
    </div>


    <!-- === TABLA === -->
    <div
        class="flex flex-col bg-white border border-gray-200 rounded-md shadow-md overflow-hidden h-[60vh] min-h-[605px]">
        <div class="flex-1 overflow-y-auto">
            <table class="w-full text-sm border-collapse relative">
                <thead class="sticky top-0 z-10 bg-[#004C77] text-white uppercase text-xs tracking-wider shadow-sm">
                    <tr>
                        <th class="px-4 py-3 text-left border-b-2 border-[#003a5a] w-[40px]">
                            <mat-checkbox (change)="masterToggle()" [checked]="isAllSelected()"
                                [indeterminate]="selection.hasValue() && !isAllSelected()">
                            </mat-checkbox>
                        </th>
                        <th class="px-4 py-3 text-left border-b-2 border-[#003a5a]">Nombre</th>
                        <th class="px-4 py-3 text-left border-b-2 border-[#003a5a]">Correo</th>
                        <th class="px-4 py-3 text-left border-b-2 border-[#003a5a]">Rol</th>
                        <th class="px-4 py-3 text-left border-b-2 border-[#003a5a]">Permisos</th>
                        <th class="px-4 py-3 text-left border-b-2 border-[#003a5a]">Identidad</th>
                        <th class="px-4 py-3 text-left border-b-2 border-[#003a5a]">DNI/RUC</th>
                        <th class="px-4 py-3 text-center border-b-2 border-[#003a5a]">Acciones</th>
                    </tr>
                </thead>

                <tbody *ngIf="dataSource.data.length > 0; else sinUsuarios">
                    <tr *ngFor="let usuario of dataSource.data | slice:(page-1)*pageSize:(page-1)*pageSize+pageSize; let i = index"
                        class="border-b border-gray-200 hover:bg-[#F8FBFD] transition-all duration-150">
                        <td class="px-4 py-3">
                            <mat-checkbox (click)="$event.stopPropagation()"
                                (change)="$event ? selection.toggle(usuario) : null"
                                [checked]="selection.isSelected(usuario)">
                            </mat-checkbox>
                        </td>
                        <td class="px-4 py-3 font-medium text-gray-800">{{ usuario.nombre }}</td>
                        <td class="px-4 py-3 text-gray-600">{{ usuario.correo }}</td>
                        <td class="px-4 py-3 text-gray-600">{{ usuario.tipoUsuario || '-' }}</td>
                        <td class="px-4 py-3 text-gray-600">{{ usuario.rol || '-' }}</td>
                        <td class="px-4 py-3 text-gray-600">{{ usuario.tipoIdentidad }}</td>
                        <td class="px-4 py-3 text-gray-600">{{ usuario.tipo === 'Entidad' ? usuario.ruc : usuario.dni }}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-3">
                                <button (click)="editarUsuario(usuario)" matTooltip="Editar usuario"
                                    class="text-[#004C77] hover:text-[#003655] transition cursor-pointer">
                                    <mat-icon class="text-[19px]">edit</mat-icon>
                                </button>
                                <button (click)="eliminarUsuario(usuario)" matTooltip="Eliminar usuario"
                                    class="text-red-600 hover:text-red-800 transition cursor-pointer">
                                    <mat-icon class="text-[19px]">delete</mat-icon>
                                </button>
                                <button (click)="verHistorial(usuario)" matTooltip="Ver historial"
                                    class="text-gray-600 hover:text-gray-800 transition cursor-pointer">
                                    <mat-icon class="text-[19px]">history</mat-icon>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>

                <ng-template #sinUsuarios>
                    <tbody>
                        <tr>
                            <td colspan="8" class="text-center text-gray-500 italic py-10 bg-[#F9FAFB]">
                                No hay usuarios registrados
                            </td>
                        </tr>
                    </tbody>
                </ng-template>
            </table>
        </div>

        <!-- PAGINADOR -->
        <div
            class="flex justify-between items-center px-6 py-3 text-sm text-gray-700 bg-[#F6F8FA] border-t border-gray-300 rounded-b-md">
            <div>
                Mostrando <b>{{ (page - 1) * pageSize + 1 }}</b> -
                <b>{{ Math.min(page * pageSize, dataSource.data.length) }}</b>
                de <b>{{ dataSource.data.length }}</b> registros
            </div>
            <div class="flex items-center gap-2">
                <button (click)="page = page > 1 ? page - 1 : 1" [disabled]="page === 1"
                    class="px-3 py-1 text-[#004C77] border border-gray-300 rounded-md hover:bg-[#E5EDF3] disabled:opacity-50 transition-all cursor-pointer"
                    matTooltip="Página anterior">
                    ◀
                </button>
                <span class="text-gray-600 font-medium">Página {{ page }} / {{ totalPages }}</span>
                <button (click)="page = page < totalPages ? page + 1 : totalPages" [disabled]="page === totalPages"
                    class="px-3 py-1 text-[#004C77] border border-gray-300 rounded-md hover:bg-[#E5EDF3] disabled:opacity-50 transition-all cursor-pointer"
                    matTooltip="Página siguiente">
                    ▶
                </button>
            </div>
        </div>
    </div>
</div>